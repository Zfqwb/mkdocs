
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="MkDocs Material Boilerplate (Starter Kit) - Deploy documentation to hosting platforms (Netlify, GitHub Pages, GitLab Pages, and AWS Amplify Console) with Docker, pipenv, and GitHub Actions.">
      
      
      
        <meta name="author" content="nitto">
      
      
        <link rel="canonical" href="https://nitto.netlify.app/tantan/day06/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>day06 - Nitto Java Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
      <link rel="manifest" href="../../manifest.json" crossorigin="use-credentials">
    
    
      <link rel="stylesheet" href="../../assets/css/custom.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Nitto Java Docs" class="md-header__button md-logo" aria-label="Nitto Java Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nitto Java Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              day06
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/Zfqwb/mkdocs/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Nitto Java Docs" class="md-nav__button md-logo" aria-label="Nitto Java Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Nitto Java Docs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Zfqwb/mkdocs/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../MySQL/" class="md-nav__link">
        Mysql
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../jquery/" class="md-nav__link">
        JQuery
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../ajax/" class="md-nav__link">
        AJAX
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Redis
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Redis" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/day01/" class="md-nav__link">
        day01
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/day02/" class="md-nav__link">
        day02
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Docker
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Docker" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/1/" class="md-nav__link">
        初识 Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/2/" class="md-nav__link">
        docker命令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/3/" class="md-nav__link">
        docker容器的数据卷
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/4/" class="md-nav__link">
        docker部署容器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/5/" class="md-nav__link">
        Docerfile
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/6/" class="md-nav__link">
        服务编排
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/7/" class="md-nav__link">
        私有仓库
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../MongoDB/MongoDB/" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      <label class="md-nav__link" for="__nav_8">
        项目一-探花交友
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="项目一-探花交友" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          项目一-探花交友
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day01/" class="md-nav__link">
        day01
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day02/" class="md-nav__link">
        day02
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day03/" class="md-nav__link">
        day03
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day04/" class="md-nav__link">
        day04
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day05/" class="md-nav__link">
        day05
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          day06
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        day06
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    课程说明
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、视频点赞
  </a>
  
    <nav class="md-nav" aria-label="1、视频点赞">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11dubbo" class="md-nav__link">
    1.1、dubbo服务
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12app" class="md-nav__link">
    1.2、APP接口服务
  </a>
  
    <nav class="md-nav" aria-label="1.2、APP接口服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121videocontroller" class="md-nav__link">
    1.2.1、VideoController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122videoservice" class="md-nav__link">
    1.2.2、VideoService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123" class="md-nav__link">
    1.2.3、修改点赞数查询
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、视频评论
  </a>
  
    <nav class="md-nav" aria-label="2、视频评论">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21videocontroller" class="md-nav__link">
    2.1、VideoController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22videoservice" class="md-nav__link">
    2.2、VideoService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    2.3、查询评论数
  </a>
  
    <nav class="md-nav" aria-label="2.3、查询评论数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231dubbo" class="md-nav__link">
    2.3.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="2.3.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2311" class="md-nav__link">
    2.3.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2312" class="md-nav__link">
    2.3.1.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232" class="md-nav__link">
    2.3.2、查询评论数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    2.4、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、关注用户
  </a>
  
    <nav class="md-nav" aria-label="3、关注用户">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31dubbo" class="md-nav__link">
    3.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="3.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311followuser" class="md-nav__link">
    3.1.1、FollowUser
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312" class="md-nav__link">
    3.1.2、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313" class="md-nav__link">
    3.1.3、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32app" class="md-nav__link">
    3.2、APP服务
  </a>
  
    <nav class="md-nav" aria-label="3.2、APP服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321videocontroller" class="md-nav__link">
    3.2.1、VideoController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322videoservice" class="md-nav__link">
    3.2.2、VideoService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323" class="md-nav__link">
    3.2.3、查询是否关注
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    3.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、即时通信
  </a>
  
    <nav class="md-nav" aria-label="4、即时通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1、什么是即时通信？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2、功能说明
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、技术方案
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、环信
  </a>
  
    <nav class="md-nav" aria-label="6、环信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1、开发简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62console" class="md-nav__link">
    6.2、环信Console
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    6.3、整体流程图
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7、获取管理员权限
  </a>
  
    <nav class="md-nav" aria-label="7、获取管理员权限">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71dubbo" class="md-nav__link">
    7.1、创建dubbo工程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    7.2、配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    7.3、编写实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74" class="md-nav__link">
    7.4、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75" class="md-nav__link">
    7.5、实现接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76" class="md-nav__link">
    7.6、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8、用户系统集成
  </a>
  
    <nav class="md-nav" aria-label="8、用户系统集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    8.1、通用请求逻辑
  </a>
  
    <nav class="md-nav" aria-label="8.1、通用请求逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#811spring-retry" class="md-nav__link">
    8.1.1、Spring-Retry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#812requestservice" class="md-nav__link">
    8.1.2、RequestService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    8.2、注册环信用户
  </a>
  
    <nav class="md-nav" aria-label="8.2、注册环信用户">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#821huanxinuser" class="md-nav__link">
    8.2.1、HuanXinUser
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#822" class="md-nav__link">
    8.2.2、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#823" class="md-nav__link">
    8.2.3、实现接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#824" class="md-nav__link">
    8.2.4、测试用例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#825sso" class="md-nav__link">
    8.2.5、在sso中注册环信用户
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#826" class="md-nav__link">
    8.2.6、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83" class="md-nav__link">
    8.3、查询环信用户信息
  </a>
  
    <nav class="md-nav" aria-label="8.3、查询环信用户信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#831huanxinuservo" class="md-nav__link">
    8.3.1、HuanXinUserVo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#832huanxincontroller" class="md-nav__link">
    8.3.2、HuanXinController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#833huanxinservice" class="md-nav__link">
    8.3.3、HuanXinService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#834" class="md-nav__link">
    8.3.4、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84" class="md-nav__link">
    8.4、查询个人信息
  </a>
  
    <nav class="md-nav" aria-label="8.4、查询个人信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#841dubbo" class="md-nav__link">
    8.4.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="8.4.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#8411" class="md-nav__link">
    8.4.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8412" class="md-nav__link">
    8.4.1.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#842app" class="md-nav__link">
    8.4.2、APP接口服务
  </a>
  
    <nav class="md-nav" aria-label="8.4.2、APP接口服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#8421userinfovo" class="md-nav__link">
    8.4.2.1、UserInfoVo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8422imcontroller" class="md-nav__link">
    8.4.2.2、IMController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8423imservice" class="md-nav__link">
    8.4.2.3、IMService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8424" class="md-nav__link">
    8.4.2.4、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85id" class="md-nav__link">
    8.5、根据用户id查询个人信息
  </a>
  
    <nav class="md-nav" aria-label="8.5、根据用户id查询个人信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#851mycentercontroller" class="md-nav__link">
    8.5.1、MyCenterController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#852mycenterservice" class="md-nav__link">
    8.5.2、MyCenterService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#853" class="md-nav__link">
    8.5.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86" class="md-nav__link">
    8.6、发送消息给客户端
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#87" class="md-nav__link">
    8.7、将用户数据同步到环信
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9、 添加联系人
  </a>
  
    <nav class="md-nav" aria-label="9、 添加联系人">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91dubbo" class="md-nav__link">
    9.1、好友dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="9.1、好友dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#911" class="md-nav__link">
    9.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#912" class="md-nav__link">
    9.1.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92dubbo" class="md-nav__link">
    9.2、环信dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="9.2、环信dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#921" class="md-nav__link">
    9.2.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922" class="md-nav__link">
    9.2.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93app" class="md-nav__link">
    9.3、APP接口服务
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94" class="md-nav__link">
    9.4、测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95" class="md-nav__link">
    9.5、重新生成好友关系数据
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    10、联系人列表
  </a>
  
    <nav class="md-nav" aria-label="10、联系人列表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101dubbo" class="md-nav__link">
    10.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="10.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1011" class="md-nav__link">
    10.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1012" class="md-nav__link">
    10.1.2、接口实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102app" class="md-nav__link">
    10.2、APP接口服务
  </a>
  
    <nav class="md-nav" aria-label="10.2、APP接口服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1021usersvo" class="md-nav__link">
    10.2.1、UsersVo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1022imcontroller" class="md-nav__link">
    10.2.2、IMController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1023imservice" class="md-nav__link">
    10.2.3、IMService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    10.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day07/" class="md-nav__link">
        day07
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day08/" class="md-nav__link">
        day08
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day09/" class="md-nav__link">
        day09
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day10/" class="md-nav__link">
        day10
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_11" type="checkbox" id="__nav_8_11" >
      
      <label class="md-nav__link" for="__nav_8_11">
        补充资料
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="补充资料" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_11">
          <span class="md-nav__icon md-icon"></span>
          补充资料
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/lombok/" class="md-nav__link">
        day01_lombok
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/mybatisPlus/" class="md-nav__link">
        day01_mybatis_plus
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/aliyun/" class="md-nav__link">
        day01_阿里云
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/sso/" class="md-nav__link">
        day01_单点登录及jwt
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/nginx/" class="md-nav__link">
        day03_nginx
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/threadlocal/README.md" class="md-nav__link">
        day03_ThreadLocal
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/mongodb/" class="md-nav__link">
        day04_MongoDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/ansy/" class="md-nav__link">
        day04_多线程@Ansy
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      <label class="md-nav__link" for="__nav_9">
        面试
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          面试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interview/e.g.1.0.0/" class="md-nav__link">
        e.g.1.0.0
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    课程说明
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、视频点赞
  </a>
  
    <nav class="md-nav" aria-label="1、视频点赞">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11dubbo" class="md-nav__link">
    1.1、dubbo服务
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12app" class="md-nav__link">
    1.2、APP接口服务
  </a>
  
    <nav class="md-nav" aria-label="1.2、APP接口服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121videocontroller" class="md-nav__link">
    1.2.1、VideoController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122videoservice" class="md-nav__link">
    1.2.2、VideoService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123" class="md-nav__link">
    1.2.3、修改点赞数查询
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、视频评论
  </a>
  
    <nav class="md-nav" aria-label="2、视频评论">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21videocontroller" class="md-nav__link">
    2.1、VideoController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22videoservice" class="md-nav__link">
    2.2、VideoService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    2.3、查询评论数
  </a>
  
    <nav class="md-nav" aria-label="2.3、查询评论数">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#231dubbo" class="md-nav__link">
    2.3.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="2.3.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2311" class="md-nav__link">
    2.3.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2312" class="md-nav__link">
    2.3.1.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232" class="md-nav__link">
    2.3.2、查询评论数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    2.4、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、关注用户
  </a>
  
    <nav class="md-nav" aria-label="3、关注用户">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31dubbo" class="md-nav__link">
    3.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="3.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311followuser" class="md-nav__link">
    3.1.1、FollowUser
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312" class="md-nav__link">
    3.1.2、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313" class="md-nav__link">
    3.1.3、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32app" class="md-nav__link">
    3.2、APP服务
  </a>
  
    <nav class="md-nav" aria-label="3.2、APP服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321videocontroller" class="md-nav__link">
    3.2.1、VideoController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322videoservice" class="md-nav__link">
    3.2.2、VideoService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323" class="md-nav__link">
    3.2.3、查询是否关注
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    3.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、即时通信
  </a>
  
    <nav class="md-nav" aria-label="4、即时通信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1、什么是即时通信？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2、功能说明
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、技术方案
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、环信
  </a>
  
    <nav class="md-nav" aria-label="6、环信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1、开发简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62console" class="md-nav__link">
    6.2、环信Console
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    6.3、整体流程图
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    7、获取管理员权限
  </a>
  
    <nav class="md-nav" aria-label="7、获取管理员权限">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71dubbo" class="md-nav__link">
    7.1、创建dubbo工程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    7.2、配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73" class="md-nav__link">
    7.3、编写实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74" class="md-nav__link">
    7.4、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75" class="md-nav__link">
    7.5、实现接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76" class="md-nav__link">
    7.6、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    8、用户系统集成
  </a>
  
    <nav class="md-nav" aria-label="8、用户系统集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81" class="md-nav__link">
    8.1、通用请求逻辑
  </a>
  
    <nav class="md-nav" aria-label="8.1、通用请求逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#811spring-retry" class="md-nav__link">
    8.1.1、Spring-Retry
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#812requestservice" class="md-nav__link">
    8.1.2、RequestService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    8.2、注册环信用户
  </a>
  
    <nav class="md-nav" aria-label="8.2、注册环信用户">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#821huanxinuser" class="md-nav__link">
    8.2.1、HuanXinUser
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#822" class="md-nav__link">
    8.2.2、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#823" class="md-nav__link">
    8.2.3、实现接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#824" class="md-nav__link">
    8.2.4、测试用例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#825sso" class="md-nav__link">
    8.2.5、在sso中注册环信用户
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#826" class="md-nav__link">
    8.2.6、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83" class="md-nav__link">
    8.3、查询环信用户信息
  </a>
  
    <nav class="md-nav" aria-label="8.3、查询环信用户信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#831huanxinuservo" class="md-nav__link">
    8.3.1、HuanXinUserVo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#832huanxincontroller" class="md-nav__link">
    8.3.2、HuanXinController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#833huanxinservice" class="md-nav__link">
    8.3.3、HuanXinService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#834" class="md-nav__link">
    8.3.4、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84" class="md-nav__link">
    8.4、查询个人信息
  </a>
  
    <nav class="md-nav" aria-label="8.4、查询个人信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#841dubbo" class="md-nav__link">
    8.4.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="8.4.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#8411" class="md-nav__link">
    8.4.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8412" class="md-nav__link">
    8.4.1.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#842app" class="md-nav__link">
    8.4.2、APP接口服务
  </a>
  
    <nav class="md-nav" aria-label="8.4.2、APP接口服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#8421userinfovo" class="md-nav__link">
    8.4.2.1、UserInfoVo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8422imcontroller" class="md-nav__link">
    8.4.2.2、IMController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8423imservice" class="md-nav__link">
    8.4.2.3、IMService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8424" class="md-nav__link">
    8.4.2.4、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85id" class="md-nav__link">
    8.5、根据用户id查询个人信息
  </a>
  
    <nav class="md-nav" aria-label="8.5、根据用户id查询个人信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#851mycentercontroller" class="md-nav__link">
    8.5.1、MyCenterController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#852mycenterservice" class="md-nav__link">
    8.5.2、MyCenterService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#853" class="md-nav__link">
    8.5.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86" class="md-nav__link">
    8.6、发送消息给客户端
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#87" class="md-nav__link">
    8.7、将用户数据同步到环信
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9、 添加联系人
  </a>
  
    <nav class="md-nav" aria-label="9、 添加联系人">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91dubbo" class="md-nav__link">
    9.1、好友dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="9.1、好友dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#911" class="md-nav__link">
    9.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#912" class="md-nav__link">
    9.1.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92dubbo" class="md-nav__link">
    9.2、环信dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="9.2、环信dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#921" class="md-nav__link">
    9.2.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922" class="md-nav__link">
    9.2.2、编写实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93app" class="md-nav__link">
    9.3、APP接口服务
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94" class="md-nav__link">
    9.4、测试
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95" class="md-nav__link">
    9.5、重新生成好友关系数据
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    10、联系人列表
  </a>
  
    <nav class="md-nav" aria-label="10、联系人列表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101dubbo" class="md-nav__link">
    10.1、dubbo服务
  </a>
  
    <nav class="md-nav" aria-label="10.1、dubbo服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1011" class="md-nav__link">
    10.1.1、定义接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1012" class="md-nav__link">
    10.1.2、接口实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102app" class="md-nav__link">
    10.2、APP接口服务
  </a>
  
    <nav class="md-nav" aria-label="10.2、APP接口服务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1021usersvo" class="md-nav__link">
    10.2.1、UsersVo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1022imcontroller" class="md-nav__link">
    10.2.2、IMController
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1023imservice" class="md-nav__link">
    10.2.3、IMService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103" class="md-nav__link">
    10.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Zfqwb/mkdocs/edit/main/docs_sample/tantan/day06/README.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>day06</h1>
                
                <h2 id="_1">课程说明<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>实现视频点赞、评论、关注功能</li>
<li>了解什么是即时通信</li>
<li>了解探花交友的消息功能</li>
<li>了解即时通信的技术方案</li>
<li>了解环信的即时通讯</li>
<li>实现环信的用户体系集成</li>
<li>实现添加联系人、联系人列表功能</li>
</ul>
<h2 id="1">1、视频点赞<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>点赞逻辑与圈子点赞逻辑一致，所以可以复用圈子点赞的逻辑，需要注意的是点赞对象是Video，设置publishUserId的逻辑也需要完善下。</p>
<h3 id="11dubbo">1.1、dubbo服务<a class="headerlink" href="#11dubbo" title="Permanent link">&para;</a></h3>
<p>修改保存Comment逻辑，在原有逻辑中增加对小视频的支持：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.QuanZiApiImpl</span>

    <span class="cm">/**</span>
<span class="cm">     * 保存Comment</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="nf">saveComment</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">String</span> <span class="n">publishId</span><span class="p">,</span>
                                <span class="n">CommentType</span> <span class="n">commentType</span><span class="p">,</span> <span class="n">String</span> <span class="n">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Comment</span> <span class="n">comment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Comment</span><span class="p">();</span>
            <span class="n">comment</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
            <span class="n">comment</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="n">comment</span><span class="p">.</span><span class="na">setPublishId</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">publishId</span><span class="p">));</span>
            <span class="c1">// 评论类型</span>
            <span class="n">comment</span><span class="p">.</span><span class="na">setCommentType</span><span class="p">(</span><span class="n">commentType</span><span class="p">.</span><span class="na">getType</span><span class="p">());</span>
            <span class="c1">// 内容</span>
            <span class="n">comment</span><span class="p">.</span><span class="na">setContent</span><span class="p">(</span><span class="n">content</span><span class="p">);</span>
            <span class="n">comment</span><span class="p">.</span><span class="na">setCreated</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>

            <span class="n">Publish</span> <span class="n">publish</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">queryPublishById</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">publish</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">comment</span><span class="p">.</span><span class="na">setPublishUserId</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">//查询评论</span>
                <span class="n">Comment</span> <span class="n">myComment</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">queryCommentById</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">myComment</span><span class="p">)){</span>
                    <span class="n">comment</span><span class="p">.</span><span class="na">setPublishUserId</span><span class="p">(</span><span class="n">myComment</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="c1">//查询小视频</span>
                    <span class="n">Video</span> <span class="n">video</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">queryVideoById</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">video</span><span class="p">)){</span>
                        <span class="n">comment</span><span class="p">.</span><span class="na">setPublishUserId</span><span class="p">(</span><span class="n">video</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="c1">// 其他情况，直接返回</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">comment</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;保存Comment出错~ userId = &quot;</span> <span class="o">+</span> <span class="n">userId</span> <span class="o">+</span> <span class="s">&quot;, publishId = &quot;</span> <span class="o">+</span> <span class="n">publishId</span> <span class="o">+</span> <span class="s">&quot;, commentType = &quot;</span> <span class="o">+</span> <span class="n">commentType</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<p>在VideoApi中定义根据id查询Video的方法：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// com.tanhua.dubbo.server.api.VideoApi</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据id查询视频对象</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId 小视频id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Video</span> <span class="nf">queryVideoById</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">);</span>
</code></pre></div>

<p>编写实现：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// com.tanhua.dubbo.server.api.VideoApiImpl</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Video</span> <span class="nf">queryVideoById</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">videoId</span><span class="p">),</span> <span class="n">Video</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="12app">1.2、APP接口服务<a class="headerlink" href="#12app" title="Permanent link">&para;</a></h3>
<p>接口地址：</p>
<ul>
<li>点赞 https://mock-java.itheima.net/project/35/interface/api/827</li>
<li>取消点赞：https://mock-java.itheima.net/project/35/interface/api/833</li>
</ul>
<h4 id="121videocontroller">1.2.1、VideoController<a class="headerlink" href="#121videocontroller" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code>    <span class="cm">/**</span>
<span class="cm">     * 视频点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId 视频id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/{id}/like&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">likeComment</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Long</span> <span class="n">likeCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">likeComment</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">likeCount</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">likeCount</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/{id}/dislike&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">disLikeComment</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Long</span> <span class="n">likeCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">disLikeComment</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">likeCount</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">likeCount</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="122videoservice">1.2.2、VideoService<a class="headerlink" href="#122videoservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.service.VideoService</span>

    <span class="cm">/**</span>
<span class="cm">     * 点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">likeComment</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">likeComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">disLikeComment</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">disLikeComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="123">1.2.3、修改点赞数查询<a class="headerlink" href="#123" title="Permanent link">&para;</a></h4>
<p>在查询小视频列表中，需要完善之前TODO的部分。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.service.VideoService</span>

    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryVideoList</span><span class="p">(</span><span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">queryVideoList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">records</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//查询用户信息</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s">&quot;userId&quot;</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserIdList</span><span class="p">(</span><span class="n">userIds</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">VideoVo</span><span class="o">&gt;</span> <span class="n">videoVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Video</span> <span class="n">record</span> <span class="p">:</span> <span class="n">records</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">VideoVo</span> <span class="n">videoVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VideoVo</span><span class="p">();</span>

            <span class="n">videoVo</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setCover</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getPicUrl</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setVideoUrl</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getVideoUrl</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toHexString</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setSignature</span><span class="p">(</span><span class="s">&quot;我就是我~&quot;</span><span class="p">);</span> <span class="c1">//TODO 签名</span>

            <span class="n">videoVo</span><span class="p">.</span><span class="na">setCommentCount</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//TODO 评论数</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasFocus</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//TODO 是否关注</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasLiked</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryUserIsLike</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否点赞（1是，0否）</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setLikeCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span><span class="c1">//点赞数</span>

            <span class="c1">//填充用户信息</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="n">videoVo</span><span class="p">.</span><span class="na">setNickname</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span>
                    <span class="n">videoVo</span><span class="p">.</span><span class="na">setAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getLogo</span><span class="p">());</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">videoVoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">videoVo</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="n">videoVoList</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="2">2、视频评论<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>小视频的评论与圈子的评论逻辑类似，所以也可以使用同一套逻辑，所以只需要开发APP接口功能即可。</p>
<p>评论相关的接口定义：</p>
<ul>
<li>发布评论：https://mock-java.itheima.net/project/35/interface/api/857</li>
<li>评论列表：https://mock-java.itheima.net/project/35/interface/api/851</li>
<li>评论点赞：https://mock-java.itheima.net/project/35/interface/api/863</li>
<li>评论取消点赞：https://mock-java.itheima.net/project/35/interface/api/869</li>
</ul>
<h3 id="21videocontroller">2.1、VideoController<a class="headerlink" href="#21videocontroller" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code> <span class="c1">//com.tanhua.server.controller.VideoController</span>

    <span class="cm">/**</span>
<span class="cm">     * 评论列表</span>
<span class="cm">     */</span>
    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/{id}/comments&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">PageResult</span><span class="o">&gt;</span> <span class="nf">queryCommentsList</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">videoId</span><span class="p">,</span>
                                                        <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span>
                                                        <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;pagesize&quot;</span><span class="p">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;10&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">queryCommentList</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">pageResult</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 提交评论</span>
<span class="cm">     *</span>
<span class="cm">     * @param param</span>
<span class="cm">     * @param videoId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/{id}/comments&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">saveComments</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">param</span><span class="p">,</span>
                                             <span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">param</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">);</span>
            <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">saveComment</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 评论点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoCommentId 视频中的评论id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/comments/{id}/like&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">commentsLikeComment</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">videoCommentId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Long</span> <span class="n">likeCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">likeComment</span><span class="p">(</span><span class="n">videoCommentId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">likeCount</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">likeCount</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 评论取消点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoCommentId 视频中的评论id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/comments/{id}/dislike&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">disCommentsLikeComment</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">videoCommentId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Long</span> <span class="n">likeCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">disLikeComment</span><span class="p">(</span><span class="n">videoCommentId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">likeCount</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">likeCount</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="22videoservice">2.2、VideoService<a class="headerlink" href="#22videoservice" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// com.tanhua.server.service.VideoService</span>

<span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryCommentList</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiService</span><span class="p">.</span><span class="na">queryCommentList</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">saveComment</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">,</span> <span class="n">String</span> <span class="n">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiService</span><span class="p">.</span><span class="na">saveComments</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="23">2.3、查询评论数<a class="headerlink" href="#23" title="Permanent link">&para;</a></h3>
<p>在小视频列表查询结果中，需要返回该视频的评论数据，由于之前在dubbo服务中没有提供查询方法，所以需要先实现查询方法。</p>
<h4 id="231dubbo">2.3.1、dubbo服务<a class="headerlink" href="#231dubbo" title="Permanent link">&para;</a></h4>
<h5 id="2311">2.3.1.1、定义接口<a class="headerlink" href="#2311" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.QuanZiApi</span>

    <span class="cm">/**</span>
<span class="cm">     * 查询评论数</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Long</span> <span class="nf">queryCommentCount</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">);</span>
</code></pre></div>

<h5 id="2312">2.3.1.2、编写实现<a class="headerlink" href="#2312" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">// com.tanhua.dubbo.server.api.QuanZiApiImpl</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">queryCommentCount</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">queryCommentCount</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="n">CommentType</span><span class="p">.</span><span class="na">COMMENT</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="232">2.3.2、查询评论数<a class="headerlink" href="#232" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.service.VideoService</span>

<span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryVideoList</span><span class="p">(</span><span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">queryVideoList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">records</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//查询用户信息</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s">&quot;userId&quot;</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserIdList</span><span class="p">(</span><span class="n">userIds</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">VideoVo</span><span class="o">&gt;</span> <span class="n">videoVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Video</span> <span class="n">record</span> <span class="p">:</span> <span class="n">records</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">VideoVo</span> <span class="n">videoVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VideoVo</span><span class="p">();</span>

            <span class="n">videoVo</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setCover</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getPicUrl</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setVideoUrl</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getVideoUrl</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toHexString</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setSignature</span><span class="p">(</span><span class="s">&quot;我就是我~&quot;</span><span class="p">);</span> <span class="c1">//TODO 签名</span>

            <span class="n">videoVo</span><span class="p">.</span><span class="na">setCommentCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryCommentCount</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span> <span class="c1">//评论数</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasFocus</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//TODO 是否关注</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasLiked</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryUserIsLike</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否点赞（1是，0否）</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setLikeCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span><span class="c1">//点赞数</span>

            <span class="c1">//填充用户信息</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="n">videoVo</span><span class="p">.</span><span class="na">setNickname</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span>
                    <span class="n">videoVo</span><span class="p">.</span><span class="na">setAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getLogo</span><span class="p">());</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">videoVoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">videoVo</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="n">videoVoList</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="24">2.4、测试<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<p><img alt="image-20201228152357376" src="assets/image-20201228152357376.png" /></p>
<h2 id="3">3、关注用户<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>关注用户是关注小视频发布的作者，需要在dubbo服务中提供给相关的服务。</p>
<h3 id="31dubbo">3.1、dubbo服务<a class="headerlink" href="#31dubbo" title="Permanent link">&para;</a></h3>
<h4 id="311followuser">3.1.1、FollowUser<a class="headerlink" href="#311followuser" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.pojo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.bson.types.ObjectId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 关注用户</span>
<span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Document</span><span class="p">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">&quot;follow_user&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FollowUser</span> <span class="kd">implements</span> <span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">Serializable</span><span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">3148619072405056052L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">ObjectId</span> <span class="n">id</span><span class="p">;</span> <span class="c1">//主键id</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="p">;</span> <span class="c1">//用户id</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">followUserId</span><span class="p">;</span> <span class="c1">//关注的用户id</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">created</span><span class="p">;</span> <span class="c1">//关注时间</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="312">3.1.2、定义接口<a class="headerlink" href="#312" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.VideoApi</span>

    <span class="cm">/**</span>
<span class="cm">     * 关注用户</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId 当前用户</span>
<span class="cm">     * @param followUserId 关注的目标用户</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">followUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">followUserId</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消关注用户</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId 当前用户</span>
<span class="cm">     * @param followUserId 关注的目标用户</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">disFollowUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">followUserId</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * 查询用户是否关注某个用户</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId 当前用户</span>
<span class="cm">     * @param followUserId 关注的目标用户</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">isFollowUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">followUserId</span><span class="p">);</span>
</code></pre></div>

<h4 id="313">3.1.3、编写实现<a class="headerlink" href="#313" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.VideoApiImpl</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VIDEO_FOLLOW_USER_KEY_PREFIX</span> <span class="o">=</span> <span class="s">&quot;VIDEO_FOLLOW_USER_&quot;</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">followUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">followUserId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isAllNotEmpty</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">followUserId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">//需要将用户的关注列表，保存到redis中，方便后续的查询</span>
            <span class="c1">//使用redis的hash结构</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">isFollowUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">followUserId</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">FollowUser</span> <span class="n">followUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FollowUser</span><span class="p">();</span>
            <span class="n">followUser</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
            <span class="n">followUser</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="n">followUser</span><span class="p">.</span><span class="na">setFollowUserId</span><span class="p">(</span><span class="n">followUserId</span><span class="p">);</span>
            <span class="n">followUser</span><span class="p">.</span><span class="na">setCreated</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>

            <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">followUser</span><span class="p">);</span>

            <span class="c1">//保存数据到redis</span>
            <span class="n">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">getVideoFollowUserKey</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="n">String</span> <span class="n">hashKey</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">followUserId</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="na">redisTemplate</span><span class="p">.</span><span class="na">opsForHash</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">redisKey</span><span class="p">,</span> <span class="n">hashKey</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">disFollowUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">followUserId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isAllNotEmpty</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">followUserId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="na">isFollowUser</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">followUserId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//取消关注，删除关注数据即可</span>
        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">Criteria</span><span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">(</span><span class="s">&quot;followUserId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">followUserId</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="n">DeleteResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">FollowUser</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">getDeletedCount</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//同时删除redis中的数据</span>
            <span class="n">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">getVideoFollowUserKey</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="n">String</span> <span class="n">hashKey</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">followUserId</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="na">redisTemplate</span><span class="p">.</span><span class="na">opsForHash</span><span class="p">().</span><span class="na">delete</span><span class="p">(</span><span class="n">redisKey</span><span class="p">,</span> <span class="n">hashKey</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">isFollowUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">followUserId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">getVideoFollowUserKey</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">hashKey</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">followUserId</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">redisTemplate</span><span class="p">.</span><span class="na">opsForHash</span><span class="p">().</span><span class="na">hasKey</span><span class="p">(</span><span class="n">redisKey</span><span class="p">,</span> <span class="n">hashKey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getVideoFollowUserKey</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">VIDEO_FOLLOW_USER_KEY_PREFIX</span> <span class="o">+</span> <span class="n">userId</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="32app">3.2、APP服务<a class="headerlink" href="#32app" title="Permanent link">&para;</a></h3>
<p>关注用户：https://mock-java.itheima.net/project/35/interface/api/839</p>
<p>取消关注：https://mock-java.itheima.net/project/35/interface/api/845</p>
<h4 id="321videocontroller">3.2.1、VideoController<a class="headerlink" href="#321videocontroller" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.controller.VideoController</span>

<span class="cm">/**</span>
<span class="cm"> * 视频用户关注</span>
<span class="cm"> */</span>
<span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/{id}/userFocus&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">saveUserFocusComments</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">Boolean</span> <span class="n">bool</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">followUser</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 取消视频用户关注</span>
<span class="cm"> */</span>
<span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/{id}/userUnFocus&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">saveUserUnFocusComments</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">Boolean</span> <span class="n">bool</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoService</span><span class="p">.</span><span class="na">disFollowUser</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="322videoservice">3.2.2、VideoService<a class="headerlink" href="#322videoservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.service.VideoService</span>

<span class="cm">/**</span>
<span class="cm"> * 关注用户</span>
<span class="cm"> *</span>
<span class="cm"> * @param userId</span>
<span class="cm"> * @return</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">followUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">followUser</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">userId</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 取消关注</span>
<span class="cm"> *</span>
<span class="cm"> * @param userId</span>
<span class="cm"> * @return</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">disFollowUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">disFollowUser</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">userId</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="323">3.2.3、查询是否关注<a class="headerlink" href="#323" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.service.VideoService</span>

<span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryVideoList</span><span class="p">(</span><span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

    <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
    <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
    <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

    <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">queryVideoList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">records</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//查询用户信息</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s">&quot;userId&quot;</span><span class="p">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserIdList</span><span class="p">(</span><span class="n">userIds</span><span class="p">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">VideoVo</span><span class="o">&gt;</span> <span class="n">videoVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Video</span> <span class="n">record</span> <span class="p">:</span> <span class="n">records</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">VideoVo</span> <span class="n">videoVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VideoVo</span><span class="p">();</span>

        <span class="n">videoVo</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
        <span class="n">videoVo</span><span class="p">.</span><span class="na">setCover</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getPicUrl</span><span class="p">());</span>
        <span class="n">videoVo</span><span class="p">.</span><span class="na">setVideoUrl</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getVideoUrl</span><span class="p">());</span>
        <span class="n">videoVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toHexString</span><span class="p">());</span>
        <span class="n">videoVo</span><span class="p">.</span><span class="na">setSignature</span><span class="p">(</span><span class="s">&quot;我就是我~&quot;</span><span class="p">);</span> <span class="c1">//TODO 签名</span>

        <span class="n">videoVo</span><span class="p">.</span><span class="na">setCommentCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryCommentCount</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span> <span class="c1">//评论数</span>
        <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasFocus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">isFollowUser</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoVo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否关注</span>
        <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasLiked</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryUserIsLike</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否点赞（1是，0否）</span>
        <span class="n">videoVo</span><span class="p">.</span><span class="na">setLikeCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span><span class="c1">//点赞数</span>

        <span class="c1">//填充用户信息</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()))</span> <span class="p">{</span>
                <span class="n">videoVo</span><span class="p">.</span><span class="na">setNickname</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span>
                <span class="n">videoVo</span><span class="p">.</span><span class="na">setAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getLogo</span><span class="p">());</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">videoVoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">videoVo</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="n">videoVoList</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="33">3.3、测试<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<p><img alt="image-20201228162135491" src="assets/image-20201228162135491.png" /></p>
<p>可以看到，已经完成了关注用户。</p>
<h2 id="4">4、即时通信<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1、什么是即时通信？<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<p><img alt="1569567156116" src="assets/1569567156116.png" /></p>
<h3 id="42">4.2、功能说明<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<p>在探花交友项目中也提供了类似微信的聊天功能，用户可以和好友或陌生人聊天。</p>
<p>如果是陌生人，通过《聊一下》功能进行打招呼，如果对方同意后，就成为了好友，可以进行聊天了。</p>
<p>陌生人之间如果相互喜欢，那么就会成为好友，也就可以聊天了。</p>
<p>在消息界面中也可以查看：点赞、评论、喜欢、公告等消息信息。</p>
<p><img alt="1570760685758" src="assets/1570760685758.png" /></p>
<p><img alt="1570760715769" src="assets/1570760715769.png" /></p>
<p><img alt="1570760768500" src="assets/1570760768500.png" /></p>
<h2 id="5">5、技术方案<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>对于高并发的即时通讯实现，还是很有挑战的，所需要考虑的点非常多，除了要实现功能，还要考虑并发、流量、负载、服务器、容灾等等。虽然有难度也并不是高不可攀。</p>
<p>对于现实即时通讯往往有两种方案：</p>
<ul>
<li>方案一：</li>
<li>自主实现，从设计到架构，再到实现。</li>
<li>技术方面可以采用：Netty + WebSocket + RocketMQ + MongoDB + Redis + ZooKeeper + MySQL</li>
<li><img alt="1570761873597" src="assets/1570761873597.png" /></li>
<li>方案二：</li>
<li>对接第三方服务完成。</li>
<li>这种方式简单，只需要按照第三方的api进行对接就可以了。</li>
<li>如：环信、网易、容联云通讯等。</li>
</ul>
<p>如何选择呢？</p>
<p>如果是中大型企业做项目可以选择自主研发，如果是中小型企业研发中小型的项目，选择第二种方案即可。方案一需要有大量的人力、物力的支持，开发周期长，成本高，但可控性强。方案二，成本低，开发周期短，能够快速的集成起来进行功能的开发，只是在可控性方面来说就差了一些。</p>
<p>探花交友项目选择方案二进行实现。</p>
<h2 id="6">6、环信<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<p>官网：https://www.easemob.com/  稳定健壮，消息必达，亿级并发的即时通讯云</p>
<p>环信平台为黑马学员开设的专用注册地址：https://datayi.cn/w/woVL50vR</p>
<p><img alt="1570763722654" src="assets/1570763722654.png" /></p>
<p><img alt="1570763652150" src="assets/1570763652150.png" /></p>
<h3 id="61">6.1、开发简介<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<p>文档地址：http://docs-im.easemob.com/</p>
<p>平台架构：</p>
<p><img alt="" src="assets/8720181010182444.png" /></p>
<p>集成：</p>
<p>环信和用户体系的集成主要发生在2个地方，服务器端集成和客户端集成。</p>
<p><img alt="1570776683692" src="assets/1570776683692.png" /></p>
<p>探花集成：</p>
<ul>
<li>探花前端使用AndroidSDK进行集成</li>
<li>文档：http://docs-im.easemob.com/im/android/sdk/import</li>
<li>后端集成用户体系</li>
<li>文档：http://docs-im.easemob.com/im/server/ready/user</li>
</ul>
<h3 id="62console">6.2、环信Console<a class="headerlink" href="#62console" title="Permanent link">&para;</a></h3>
<p>需要使用环信平台，那么必须要进行注册，登录之后即可创建应用。环信100以内的用户免费使用，100以上就要注册企业版了。</p>
<p>企业版价格：</p>
<p><img alt="1570778131775" src="assets/1570778131775.png" /></p>
<p>创建应用：</p>
<p><img alt="image-20201228163305986" src="assets/image-20201228163305986.png" /></p>
<p>创建完成：</p>
<p><img alt="1570778297121" src="assets/1570778297121.png" /></p>
<h3 id="63">6.3、整体流程图<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<p><img alt="image-20201228165200223" src="assets/image-20201228165200223.png" /></p>
<p>说明：</p>
<ul>
<li>在APP端与后端系统，都需要完成与环信的集成。</li>
<li>在APP端，使用Android的SDK与环信进行通信，通信时需要通过后台系统的接口查询当前用户的环信用户名和密码，进行登录环信。</li>
<li>后台系统，在用户注册后，同步注册环信用户到环信平台，在后台系统中保存环信的用户名和密码。</li>
<li>APP拿到用户名和密码后，进行登录环信，登录成功后即可向环信发送消息给好友。</li>
<li>后台系统也可以通过管理员的身份给用户发送系统信息。</li>
</ul>
<h2 id="7">7、获取管理员权限<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<p>环信提供的 REST API 需要权限才能访问，权限通过发送 HTTP 请求时携带 token 来体现。</p>
<p>官方文档：<a href="http://docs-im.easemob.com/im/server/ready/user#%E8%8E%B7%E5%8F%96%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90">获取管理员权限</a></p>
<p>与环信的集成，我们将相关的代码逻辑写入到新的dubbo工程中，名字叫：my-tanhua-dubbo-huanxin。</p>
<h3 id="71dubbo">7.1、创建dubbo工程<a class="headerlink" href="#71dubbo" title="Permanent link">&para;</a></h3>
<p>pom.xml：</p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>my-tanhua-dubbo<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.itcast.tanhua<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>my-tanhua-dubbo-huanxin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--引入interface依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>cn.itcast.tanhua<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>my-tanhua-dubbo-interface<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.baomidou<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-plus<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.baomidou<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-plus-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!--dubbo的springboot支持--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>dubbo-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--dubbo框架--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>dubbo<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--zk依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.github.sgroschupf<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>zkclient<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.netty<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>netty-all<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>cn.hutool<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hutool-all<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div>

<p>application.properties:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Spring boot application</span>
<span class="na">spring.application.name</span> <span class="o">=</span> <span class="s">itcast-tanhua-dubbo-huanxin</span>

<span class="c"># dubbo 扫描包配置</span>
<span class="na">dubbo.scan.basePackages</span> <span class="o">=</span> <span class="s">com.tanhua.dubbo.server</span>
<span class="na">dubbo.application.name</span> <span class="o">=</span> <span class="s">dubbo-provider-huanxin</span>

<span class="c">#dubbo 对外暴露的端口信息</span>
<span class="na">dubbo.protocol.name</span> <span class="o">=</span> <span class="s">dubbo</span>
<span class="na">dubbo.protocol.port</span> <span class="o">=</span> <span class="s">20881</span>

<span class="c">#dubbo注册中心的配置</span>
<span class="na">dubbo.registry.address</span> <span class="o">=</span> <span class="s">zookeeper://192.168.31.81:2181</span>
<span class="na">dubbo.registry.client</span> <span class="o">=</span> <span class="s">zkclient</span>
<span class="na">dubbo.registry.timeout</span> <span class="o">=</span> <span class="s">60000 </span>

<span class="c"># Redis相关配置</span>
<span class="na">spring.redis.jedis.pool.max-wait</span> <span class="o">=</span> <span class="s">5000ms</span>
<span class="na">spring.redis.jedis.pool.max-Idle</span> <span class="o">=</span> <span class="s">100</span>
<span class="na">spring.redis.jedis.pool.min-Idle</span> <span class="o">=</span> <span class="s">10</span>
<span class="na">spring.redis.timeout</span> <span class="o">=</span> <span class="s">10s</span>
<span class="na">spring.redis.cluster.nodes</span> <span class="o">=</span> <span class="s">192.168.31.81:6379,192.168.31.81:6380,192.168.31.81:6381</span>
<span class="na">spring.redis.cluster.max-redirects</span><span class="o">=</span><span class="s">5</span>

<span class="c">#数据库连接信息</span>
<span class="na">spring.datasource.driver-class-name</span><span class="o">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="na">spring.datasource.url</span><span class="o">=</span><span class="s">jdbc:mysql://192.168.31.81:3306/mytanhua?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span>
<span class="na">spring.datasource.username</span><span class="o">=</span><span class="s">root</span>
<span class="na">spring.datasource.password</span><span class="o">=</span><span class="s">root</span>

<span class="c"># 表名前缀</span>
<span class="na">mybatis-plus.global-config.db-config.table-prefix</span><span class="o">=</span><span class="s">tb_</span>
<span class="c"># id策略为自增长</span>
<span class="na">mybatis-plus.global-config.db-config.id-type</span><span class="o">=</span><span class="s">auto</span>
</code></pre></div>

<p>入口启动类：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span><span class="p">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span><span class="n">MongoAutoConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">MongoDataAutoConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">})</span> <span class="c1">//排除mongo的自动配置</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinDubboApplication</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">HuanXinDubboApplication</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="72">7.2、配置<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<p>相关的配置，在环信管理控制台中，可以找到相关的参数。</p>
<div class="codehilite"><pre><span></span><code><span class="c">#huanxin.properties</span>

<span class="na">tanhua.huanxin.url</span><span class="o">=</span><span class="s">http://a1.easemob.com/</span>
<span class="na">tanhua.huanxin.orgName</span><span class="o">=</span><span class="s">1105190515097562</span>
<span class="na">tanhua.huanxin.appName</span><span class="o">=</span><span class="s">tanhua</span>
<span class="na">tanhua.huanxin.clientId</span><span class="o">=</span><span class="s">YXA67ZofwHblEems-_Fh-17T2g</span>
<span class="na">tanhua.huanxin.clientSecret</span><span class="o">=</span><span class="s">YXA60r45rNy2Ux5wQ7YYoEPwynHmUZk</span>
</code></pre></div>

<p>编写配置类：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.PropertySource</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@PropertySource</span><span class="p">(</span><span class="s">&quot;classpath:huanxin.properties&quot;</span><span class="p">)</span>
<span class="nd">@ConfigurationProperties</span><span class="p">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;tanhua.huanxin&quot;</span><span class="p">)</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinConfig</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">orgName</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">appName</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientId</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">clientSecret</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>

<h3 id="73">7.3、编写实现<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<p>具体的获取token的业务逻辑在TokenService中完成。实现要点：</p>
<ul>
<li>分析官方文档中的请求url、参数、响应数据等内容</li>
<li>请求到token需要缓存到redis中，不能频繁的获取token操作，可能会被封号</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONObject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.config.HuanXinConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.core.RedisTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">redisTemplate</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">REDIS_KEY</span> <span class="o">=</span> <span class="s">&quot;HX_TOKEN&quot;</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">HuanXinConfig</span> <span class="n">huanXinConfig</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 获取token，先从redis中获取，如果没有，再去环信接口获取</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">token</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//访问环信接口获取token</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">refreshToken</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 刷新token，请求环信接口，将token存储到redis中</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">refreshToken</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getUrl</span><span class="p">()</span> <span class="o">+</span>
                <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getOrgName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span>
                <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getAppName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/token&quot;</span><span class="p">;</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">param</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">param</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;grant_type&quot;</span><span class="p">,</span> <span class="s">&quot;client_credentials&quot;</span><span class="p">);</span>
        <span class="n">param</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;client_id&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getClientId</span><span class="p">());</span>
        <span class="n">param</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;client_secret&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getClientSecret</span><span class="p">());</span>

        <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">targetUrl</span><span class="p">)</span>
                <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
                <span class="p">.</span><span class="na">timeout</span><span class="p">(</span><span class="mi">20000</span><span class="p">)</span> <span class="c1">//请求超时时间</span>
                <span class="p">.</span><span class="na">execute</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="p">.</span><span class="na">isOk</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;刷新token失败~~~ &quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">String</span> <span class="n">jsonBody</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">();</span>
        <span class="n">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="n">JSONUtil</span><span class="p">.</span><span class="na">parseObj</span><span class="p">(</span><span class="n">jsonBody</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getStr</span><span class="p">(</span><span class="s">&quot;access_token&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">token</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">//将token数据缓存到redis中，缓存时间由expires_in决定</span>
            <span class="c1">//提前1小时失效</span>
            <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getLong</span><span class="p">(</span><span class="s">&quot;expires_in&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="na">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">REDIS_KEY</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">token</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="74">7.4、定义接口<a class="headerlink" href="#74" title="Permanent link">&para;</a></h3>
<p>接口定义在my-tanhua-dubbo-interface工程中。</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.api</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 与环信平台集成的相关操作</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HuanXinApi</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * 获取环信token（获取管理员权限）</span>
<span class="cm">     * 参见：http://docs-im.easemob.com/im/server/ready/user#%E8%8E%B7%E5%8F%96%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">getToken</span><span class="p">();</span>


<span class="p">}</span>
</code></pre></div>

<h3 id="75">7.5、实现接口<a class="headerlink" href="#75" title="Permanent link">&para;</a></h3>
<p>在my-tanhua-dubbo-huanxin中完成。</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.api</span><span class="p">;</span>

<span class="nd">@Service</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinApiImpl</span> <span class="kd">implements</span> <span class="n">HuanXinApi</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">tokenService</span><span class="p">.</span><span class="na">getToken</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="76">7.6、测试<a class="headerlink" href="#76" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.HuanXinApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestHuanXinApi</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">HuanXinApi</span> <span class="n">huanXinApi</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetToken</span><span class="p">(){</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">getToken</span><span class="p">();</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>测试结果，已经保存到redis中了：</p>
<p><img alt="image-20201229095744752" src="assets/image-20201229095744752.png" /></p>
<h2 id="8">8、用户系统集成<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>使用环信平台，最重要的就是集成用户体系，基本的逻辑是这样的：新用户在注册后，同时需要注册环信用户。</p>
<p>流程如下：</p>
<p><img alt="image-20201229102452178" src="assets/image-20201229102452178.png" /></p>
<p>流程说明：</p>
<ul>
<li>用户在登录时在sso系统中进行判断，如果是新用户，在注册完成后，需要调用dubbo中的环信服务进行注册环信用户。</li>
<li>dubbo-huanxin服务在注册环信用户时，需要随机生成密码，携带token请求环信的REST API进行用户注册。</li>
<li>注册成功后，需要将环信的用户信息保存到MySQL中。</li>
<li>用户在APP端使用即时通讯功能时，需要通过环信用户信息登录到环信平台，由于数据存储到服务端，所以需要通过dubbo-huanxin进行查询。</li>
<li>在拿到环信账号信息后，登录环信，登录成功后即可与环信平台进行交互。</li>
<li>需要注意的是，APP端与环信平台交互，是不走后端系统的，是直连操作。</li>
</ul>
<p>官方文档：<a href="http://docs-im.easemob.com/im/server/ready/user#%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86">《用户管理》</a></p>
<h3 id="81">8.1、通用请求逻辑<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<p>在与环信接口通信时，使用的是环信的REST接口，所以我们需要封装一个通用的请求服务，在与所有环信接口对接时使用。</p>
<p>另外，请求接口时都需要携带token，前面我们已经将token存储到redis中，但是，可能存在这样一种情况，token在我们redis中有效，但是在环信平台已经失效，这样环信平台会给我们响应401状态码。</p>
<p>对于这种情况，我们就需要检测状态码是否为401，如果是401的话，就需要重新刷新token，再重新执行此次请求。</p>
<p>也就是要支持请求的重试。</p>
<h4 id="811spring-retry">8.1.1、Spring-Retry<a class="headerlink" href="#811spring-retry" title="Permanent link">&para;</a></h4>
<p>Spring提供了重试的功能，使用非常的简单、优雅。</p>
<blockquote>
<p><strong>第一步，导入依赖：</strong></p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="c">&lt;!--Spring重试模块--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.retry<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-retry<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>

<blockquote>
<p><strong>第二步，在启动类中添加@EnableRetry注解来激活重试功能：</strong></p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.retry.annotation.EnableRetry</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span><span class="p">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span><span class="n">MongoAutoConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">MongoDataAutoConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">})</span> <span class="c1">//排除mongo的自动配置</span>
<span class="nd">@EnableRetry</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinDubboApplication</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">HuanXinDubboApplication</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p><strong>第三步，在需要支持重试操作的Service方法中添加@Retryable注解，demo如下：</strong></p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="c1">//将此类放到test包下测试即可</span>

<span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.RandomUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.retry.annotation.Backoff</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.retry.annotation.Recover</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.retry.annotation.Retryable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RetryService</span> <span class="p">{</span>

    <span class="nd">@Retryable</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">RuntimeException</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">maxAttempts</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">backoff</span> <span class="o">=</span> <span class="nd">@Backoff</span><span class="p">(</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">2000L</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">execute</span><span class="p">(</span><span class="kt">int</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="n">RandomUtil</span><span class="p">.</span><span class="na">randomInt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;生成：&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Recover</span> <span class="c1">//全部重试失败后执行</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">recover</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;全部重试完成。。。。。&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">88</span><span class="p">;</span> <span class="c1">//返回默认</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p>@Retryable参数说明：</p>
<ul>
<li>
<p>value：抛出指定异常才会重试</p>
</li>
<li>
<p>maxAttempts：最大重试次数，默认3次</p>
</li>
<li>
<p>backoff：重试等待策略，默认使用@Backoff</p>
</li>
<li>@Backoff 的value默认为1000L，我们设置为2000L；</li>
<li>multiplier（指定延迟倍数）默认为0，表示固定暂停1秒后进行重试，如果把multiplier设置为2，则第一次重试为2秒，第二次为4秒，第三次为6秒。</li>
</ul>
<p>@Recover标注的方法，是在所有的重试都失败的情况下，最后执行该方法，该方法有2个要求：</p>
<ul>
<li>方法的第一个参数必须是 Throwable 类型，最好与 @Retryable 中的 value一致。</li>
<li>方法的返回值必须与@Retryable的方法返回值一致，否则该方法不能被执行。</li>
</ul>
<p>测试类：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestRetryService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">RetryService</span> <span class="n">retryService</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRetry</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">retryService</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="mi">90</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p><strong>测试结果，会有3次重试机会进行生成随机数，如果3次随机数都小于90，最后返回88。</strong></p>
</blockquote>
<h4 id="812requestservice">8.1.2、RequestService<a class="headerlink" href="#812requestservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.http.Method</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.exception.UnauthorizedException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.retry.annotation.Backoff</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.retry.annotation.Recover</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.retry.annotation.Retryable</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 环信接口通用请求服务</span>
<span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">TokenService</span> <span class="n">tokenService</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 通用的发送请求方法</span>
<span class="cm">     *</span>
<span class="cm">     * @param url    请求地址</span>
<span class="cm">     * @param body   请求参数</span>
<span class="cm">     * @param method 请求方法</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@Retryable</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">UnauthorizedException</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">maxAttempts</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">backoff</span> <span class="o">=</span> <span class="nd">@Backoff</span><span class="p">(</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">2000L</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
    <span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">execute</span><span class="p">(</span><span class="n">String</span> <span class="n">url</span><span class="p">,</span> <span class="n">String</span> <span class="n">body</span><span class="p">,</span> <span class="n">Method</span> <span class="n">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">tokenService</span><span class="p">.</span><span class="na">getToken</span><span class="p">();</span>

        <span class="n">HttpRequest</span> <span class="n">httpRequest</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">POST</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">httpRequest</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">case</span> <span class="n">DELETE</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">httpRequest</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">case</span> <span class="n">PUT</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">httpRequest</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">case</span> <span class="n">GET</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">httpRequest</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">default</span><span class="p">:</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">httpRequest</span>
                <span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">)</span> <span class="c1">//设置请求内容类型</span>
                <span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Bearer &quot;</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>  <span class="c1">//设置token</span>
                <span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="c1">// 设置请求数据</span>
                <span class="p">.</span><span class="na">timeout</span><span class="p">(</span><span class="mi">20000</span><span class="p">)</span> <span class="c1">// 超时时间</span>
                <span class="p">.</span><span class="na">execute</span><span class="p">();</span> <span class="c1">// 执行请求</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()</span> <span class="o">==</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//token失效，重新刷新token</span>
            <span class="k">this</span><span class="p">.</span><span class="na">tokenService</span><span class="p">.</span><span class="na">refreshToken</span><span class="p">();</span>

            <span class="c1">//抛出异常，需要进行重试</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">UnauthorizedException</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Recover</span> <span class="c1">//全部重试失败后执行</span>
    <span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">recover</span><span class="p">(</span><span class="n">UnauthorizedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;获取token失败！url = &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getUrl</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;, body = &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getBody</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;, method = &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getMethod</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span>
        <span class="c1">//如果重试5次后，依然不能获取到token，说明网络或账号出现了问题，只能返回null了，后续的请求将无法再执行</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.exception</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.http.Method</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnauthorizedException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">body</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Method</span> <span class="n">method</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>

<p>测试用例：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpResponse</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.http.Method</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.config.HuanXinConfig</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.service.RequestService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestRequestService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">RequestService</span> <span class="n">requestService</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">HuanXinConfig</span> <span class="n">huanXinConfig</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQueryHuanXinUser</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getUrl</span><span class="p">()</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getOrgName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getAppName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/users/1&quot;</span><span class="p">;</span>
        <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">requestService</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUrl</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">Method</span><span class="p">.</span><span class="na">GET</span><span class="p">);</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="82">8.2、注册环信用户<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<p>注册环信用户分为2种，开放注册、授权注册，区别在于开发注册不需要token，授权注册需要token。我们使用的授权注册。</p>
<p>官方文档：<a href="http://docs-im.easemob.com/im/server/ready/user#%E6%B3%A8%E5%86%8C%E5%8D%95%E4%B8%AA%E7%94%A8%E6%88%B7_%E6%8E%88%E6%9D%83">《注册单个用户(授权)》</a></p>
<blockquote>
<p><strong>说明：环信用户数据需要保存到数据中。</strong></p>
</blockquote>
<h4 id="821huanxinuser">8.2.1、HuanXinUser<a class="headerlink" href="#821huanxinuser" title="Permanent link">&para;</a></h4>
<p>在my-tanhua-dubbo-interface工程中创建该类：</p>
<p>需要在此工程中添加MybatisPlus依赖：</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.baomidou<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis-plus<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.pojo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.annotation.TableName</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * 环信用户对象</span>
<span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@TableName</span><span class="p">(</span><span class="s">&quot;tb_huanxin_user&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinUser</span> <span class="kd">implements</span> <span class="n">java</span><span class="p">.</span><span class="na">io</span><span class="p">.</span><span class="na">Serializable</span><span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6400630011196593976L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="p">;</span> <span class="c1">//主键Id</span>

    <span class="cm">/**</span>
<span class="cm">     * 环信 ID ;也就是 IM 用户名的唯一登录账号，长度不可超过64个字符长度</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>
    <span class="cm">/**</span>
<span class="cm">     * 登录密码，长度不可超过64个字符长度</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>
    <span class="cm">/**</span>
<span class="cm">     * 昵称（可选），在 iOS Apns 推送时会使用的昵称（仅在推送通知栏内显示的昵称），</span>
<span class="cm">     * 并不是用户个人信息的昵称，环信是不保存用户昵称，头像等个人信息的，</span>
<span class="cm">     * 需要自己服务器保存并与给自己用户注册的IM用户名绑定，长度不可超过100个字符</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nickname</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="p">;</span> <span class="c1">//用户id</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">created</span><span class="p">;</span> <span class="c1">//创建时间</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">updated</span><span class="p">;</span> <span class="c1">//更新时间</span>

<span class="p">}</span>
</code></pre></div>

<p>数据库表结构：</p>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">tb_huanxin_user</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">user_id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;用户id&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">username</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;环信用户名&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">password</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;环信密码&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">nickname</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;昵称&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">created</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;创建时间&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">updated</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">&#39;更新时间&#39;</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">user_id</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">username</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">username</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div>

<h4 id="822">8.2.2、定义接口<a class="headerlink" href="#822" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.HuanXinApi</span>

    <span class="cm">/**</span>
<span class="cm">     * 注册环信用户</span>
<span class="cm">     * 参见：http://docs-im.easemob.com/im/server/ready/user#%E6%B3%A8%E5%86%8C%E5%8D%95%E4%B8%AA%E7%94%A8%E6%88%B7_%E5%BC%80%E6%94%BE</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId 用户id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">register</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据用户Id询环信账户信息</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">HuanXinUser</span> <span class="nf">queryHuanXinUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">);</span>
</code></pre></div>

<h4 id="823">8.2.3、实现接口<a class="headerlink" href="#823" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.HuanXinApiImpl</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">register</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getUrl</span><span class="p">()</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getOrgName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span>
                <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getAppName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/users&quot;</span><span class="p">;</span>

        <span class="n">HuanXinUser</span> <span class="n">huanXinUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HuanXinUser</span><span class="p">();</span>
        <span class="n">huanXinUser</span><span class="p">.</span><span class="na">setUsername</span><span class="p">(</span><span class="s">&quot;HX_&quot;</span> <span class="o">+</span> <span class="n">userId</span><span class="p">);</span>  <span class="c1">// 用户名</span>
        <span class="n">huanXinUser</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="n">IdUtil</span><span class="p">.</span><span class="na">simpleUUID</span><span class="p">());</span> <span class="c1">//随机生成的密码</span>

        <span class="n">HttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">requestService</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUrl</span><span class="p">,</span> <span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">huanXinUser</span><span class="p">)),</span> <span class="n">Method</span><span class="p">.</span><span class="na">POST</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">isOk</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">//将环信的账号信息保存到数据库</span>
            <span class="n">huanXinUser</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="n">huanXinUser</span><span class="p">.</span><span class="na">setCreated</span><span class="p">(</span><span class="k">new</span> <span class="n">Date</span><span class="p">());</span>
            <span class="n">huanXinUser</span><span class="p">.</span><span class="na">setUpdated</span><span class="p">(</span><span class="n">huanXinUser</span><span class="p">.</span><span class="na">getCreated</span><span class="p">());</span>

            <span class="k">this</span><span class="p">.</span><span class="na">huanXinUserMapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">huanXinUser</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">HuanXinUser</span> <span class="nf">queryHuanXinUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">HuanXinUser</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">wrapper</span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">userId</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinUserMapper</span><span class="p">.</span><span class="na">selectOne</span><span class="p">(</span><span class="n">wrapper</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.mapper</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.mapper.BaseMapper</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.HuanXinUser</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="p">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HuanXinUserMapper</span> <span class="kd">extends</span> <span class="n">BaseMapper</span><span class="o">&lt;</span><span class="n">HuanXinUser</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="824">8.2.4、测试用例<a class="headerlink" href="#824" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.HuanXinApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="p">;</span>

<span class="nd">@SpringBootTest</span>
<span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestHuanXinApi</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">HuanXinApi</span> <span class="n">huanXinApi</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRegister</span><span class="p">(){</span>
        <span class="c1">//注册用户id为1的用户到环信</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="mi">1L</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQueryHuanXinUser</span><span class="p">(){</span>
        <span class="c1">//根据用户id查询环信用户信息</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">queryHuanXinUser</span><span class="p">(</span><span class="mi">1L</span><span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<h4 id="825sso">8.2.5、在sso中注册环信用户<a class="headerlink" href="#825sso" title="Permanent link">&para;</a></h4>
<p>需要在sso系统中使用dubbo服务进行注册环信用户。</p>
<blockquote>
<p><strong>第一步，导入依赖：</strong></p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>cn.itcast.tanhua<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>my-tanhua-dubbo-interface<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!--dubbo的springboot支持--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.alibaba.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>dubbo-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!--dubbo框架--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>dubbo<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!--zk依赖--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.github.sgroschupf<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>zkclient<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>

<blockquote>
<p><strong>第二步，增加dubbo注册中心配置</strong></p>
</blockquote>
<p>application.properties：</p>
<div class="codehilite"><pre><span></span><code><span class="c">#dubbo注册中心配置</span>
<span class="na">dubbo.application.name</span> <span class="o">=</span> <span class="s">itcast-tanhua-server</span>
<span class="na">dubbo.registry.address</span> <span class="o">=</span> <span class="s">zookeeper://192.168.31.81:2181</span>
<span class="na">dubbo.registry.client</span> <span class="o">=</span> <span class="s">zkclient</span>
<span class="na">dubbo.registry.timeout</span> <span class="o">=</span> <span class="s">60000</span>
<span class="na">dubbo.consumer.timeout</span> <span class="o">=</span> <span class="s">60000</span>
</code></pre></div>

<blockquote>
<p><strong>第三步，在UserService中增加相应的逻辑：</strong></p>
</blockquote>
<div class="codehilite"><pre><span></span><code>    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">HuanXinApi</span> <span class="n">huanXinApi</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 用户登录</span>
<span class="cm">     *</span>
<span class="cm">     * @param phone 手机号</span>
<span class="cm">     * @param code  验证码</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">login</span><span class="p">(</span><span class="n">String</span> <span class="n">phone</span><span class="p">,</span> <span class="n">String</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">redisKey</span> <span class="o">=</span> <span class="s">&quot;CHECK_CODE_&quot;</span> <span class="o">+</span> <span class="n">phone</span><span class="p">;</span>
        <span class="kt">boolean</span> <span class="n">isNew</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="c1">//校验验证码</span>
        <span class="n">String</span> <span class="n">redisData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">redisKey</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">redisData</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">//验证码错误</span>
        <span class="p">}</span>

        <span class="c1">//验证码在校验完成后，需要废弃</span>
        <span class="k">this</span><span class="p">.</span><span class="na">redisTemplate</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">redisKey</span><span class="p">);</span>

        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">queryWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">queryWrapper</span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="s">&quot;mobile&quot;</span><span class="p">,</span> <span class="n">phone</span><span class="p">);</span>

        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userMapper</span><span class="p">.</span><span class="na">selectOne</span><span class="p">(</span><span class="n">queryWrapper</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//需要注册该用户</span>
            <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>
            <span class="n">user</span><span class="p">.</span><span class="na">setMobile</span><span class="p">(</span><span class="n">phone</span><span class="p">);</span>
            <span class="n">user</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="n">DigestUtils</span><span class="p">.</span><span class="na">md5Hex</span><span class="p">(</span><span class="s">&quot;123456&quot;</span><span class="p">));</span>

            <span class="c1">//注册新用户</span>
            <span class="k">this</span><span class="p">.</span><span class="na">userMapper</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
            <span class="n">isNew</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

            <span class="c1">//注册环信用户</span>
            <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//注册环信失败，记录日志</span>
                <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;注册环信用户失败~ userId = &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">//生成token</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">claims</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>

        <span class="c1">// 生成token</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setClaims</span><span class="p">(</span><span class="n">claims</span><span class="p">)</span> <span class="c1">//payload，存放数据的位置，不能放置敏感数据，如：密码等</span>
                <span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS256</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span> <span class="c1">//设置加密方法和加密盐</span>
                <span class="p">.</span><span class="na">setExpiration</span><span class="p">(</span><span class="k">new</span> <span class="n">DateTime</span><span class="p">().</span><span class="na">plusHours</span><span class="p">(</span><span class="mi">12</span><span class="p">).</span><span class="na">toDate</span><span class="p">())</span> <span class="c1">//设置过期时间，12小时后过期</span>
                <span class="p">.</span><span class="na">compact</span><span class="p">();</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">//发送用户登录成功的消息</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>

            <span class="k">this</span><span class="p">.</span><span class="na">rocketMQTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;tanhua-sso-login&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">MessagingException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;发送消息失败！&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">token</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="n">isNew</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="826">8.2.6、测试<a class="headerlink" href="#826" title="Permanent link">&para;</a></h4>
<p>将服务全部跑起来，使用APP进行测试，使用新手机号进行登录测试。</p>
<p>新注册的用户：</p>
<p><img alt="image-20201229170351678" src="assets/image-20201229170351678.png" /></p>
<p>所对应的环信用户：</p>
<p><img alt="image-20201229170423587" src="assets/image-20201229170423587.png" /></p>
<p>环信平台：</p>
<p><img alt="image-20201229170507112" src="assets/image-20201229170507112.png" /></p>
<p>可以看到已经注册到了环信。</p>
<h3 id="83">8.3、查询环信用户信息<a class="headerlink" href="#83" title="Permanent link">&para;</a></h3>
<p>在app中，用户登录后需要根据用户名密码登录环信，由于用户名密码保存在后台，所以需要提供接口进行返回。</p>
<p>mock地址：  https://mock-java.itheima.net/project/35/interface/api/563</p>
<p><img alt="image-20201229170858474" src="assets/image-20201229170858474.png" /></p>
<h4 id="831huanxinuservo">8.3.1、HuanXinUserVo<a class="headerlink" href="#831huanxinuservo" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.vo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinUserVo</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>

<h4 id="832huanxincontroller">8.3.2、HuanXinController<a class="headerlink" href="#832huanxincontroller" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.controller</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.tanhua.server.service.HuanXinService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.HuanXinUserVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;huanxin&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinController</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">HuanXinService</span> <span class="n">huanXinService</span><span class="p">;</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">HuanXinUserVo</span> <span class="nf">queryHuanXinUser</span><span class="p">(){</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinService</span><span class="p">.</span><span class="na">queryHuanXinUser</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="833huanxinservice">8.3.3、HuanXinService<a class="headerlink" href="#833huanxinservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.HuanXinApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.HuanXinUser</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.HuanXinUserVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuanXinService</span> <span class="p">{</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">HuanXinApi</span> <span class="n">huanXinApi</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">HuanXinUserVo</span> <span class="nf">queryHuanXinUser</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="c1">//通过dubbo服务查询环信用户</span>
        <span class="n">HuanXinUser</span> <span class="n">huanXinUser</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">queryHuanXinUser</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">huanXinUser</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">HuanXinUserVo</span><span class="p">(</span><span class="n">huanXinUser</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span> <span class="n">huanXinUser</span><span class="p">.</span><span class="na">getPassword</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="834">8.3.4、测试<a class="headerlink" href="#834" title="Permanent link">&para;</a></h4>
<p><img alt="image-20201229202131623" src="assets/image-20201229202131623.png" /></p>
<h3 id="84">8.4、查询个人信息<a class="headerlink" href="#84" title="Permanent link">&para;</a></h3>
<p>在消息模块中，需要实现根据环信用户名查询个人的用户信息。</p>
<p>接口文档：https://mock-java.itheima.net/project/35/interface/api/2921</p>
<h4 id="841dubbo">8.4.1、dubbo服务<a class="headerlink" href="#841dubbo" title="Permanent link">&para;</a></h4>
<h5 id="8411">8.4.1.1、定义接口<a class="headerlink" href="#8411" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.HuanXinApi</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据环信用户名查询用户信息</span>
<span class="cm">     *</span>
<span class="cm">     * @param userName</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">HuanXinUser</span> <span class="nf">queryUserByUserName</span><span class="p">(</span><span class="n">String</span> <span class="n">userName</span><span class="p">);</span>
</code></pre></div>

<h5 id="8412">8.4.1.2、编写实现<a class="headerlink" href="#8412" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.HuanXinApiImpl</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">HuanXinUser</span> <span class="nf">queryUserByUserName</span><span class="p">(</span><span class="n">String</span> <span class="n">userName</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">HuanXinUser</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">wrapper</span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="n">userName</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinUserMapper</span><span class="p">.</span><span class="na">selectOne</span><span class="p">(</span><span class="n">wrapper</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="842app">8.4.2、APP接口服务<a class="headerlink" href="#842app" title="Permanent link">&para;</a></h4>
<h5 id="8421userinfovo">8.4.2.1、UserInfoVo<a class="headerlink" href="#8421userinfovo" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.vo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.annotation.Alias</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserInfoVo</span> <span class="p">{</span>

    <span class="nd">@Alias</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="p">;</span> <span class="c1">//用户id</span>
    <span class="nd">@Alias</span><span class="p">(</span><span class="s">&quot;logo&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">avatar</span><span class="p">;</span> <span class="c1">//头像</span>
    <span class="nd">@Alias</span><span class="p">(</span><span class="s">&quot;nickName&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nickname</span><span class="p">;</span> <span class="c1">//昵称</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">birthday</span><span class="p">;</span> <span class="c1">//生日 2019-09-11</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">age</span><span class="p">;</span> <span class="c1">//年龄</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">gender</span><span class="p">;</span> <span class="c1">//性别 man woman</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">city</span><span class="p">;</span> <span class="c1">//城市</span>
    <span class="nd">@Alias</span><span class="p">(</span><span class="s">&quot;edu&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">education</span><span class="p">;</span> <span class="c1">//学历</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">income</span><span class="p">;</span> <span class="c1">//月收入</span>
    <span class="nd">@Alias</span><span class="p">(</span><span class="s">&quot;industry&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">profession</span><span class="p">;</span> <span class="c1">//行业</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">marriage</span><span class="p">;</span> <span class="c1">//婚姻状态（0未婚，1已婚）</span>

<span class="p">}</span>
</code></pre></div>

<h5 id="8422imcontroller">8.4.2.2、IMController<a class="headerlink" href="#8422imcontroller" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.controller.IMController</span>

<span class="kn">package</span> <span class="nn">com.tanhua.server.controller</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.service.IMService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.UserInfoVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;messages&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IMController</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IMService</span> <span class="n">imService</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据环信用户名查询用户信息</span>
<span class="cm">     *</span>
<span class="cm">     * @param userName 环信用户</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;userinfo&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">UserInfoVo</span><span class="o">&gt;</span> <span class="nf">queryUserInfoByUserName</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">&quot;huanxinId&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">userName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">UserInfoVo</span> <span class="n">userInfoVo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">imService</span><span class="p">.</span><span class="na">queryUserInfoByUserName</span><span class="p">(</span><span class="n">userName</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">userInfoVo</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">userInfoVo</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;根据环信id查询用户信息! userName = &quot;</span> <span class="o">+</span> <span class="n">userName</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<h5 id="8423imservice">8.4.2.3、IMService<a class="headerlink" href="#8423imservice" title="Permanent link">&para;</a></h5>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.service.IMService</span>

<span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.bean.BeanUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.UserInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.HuanXinApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.HuanXinUser</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.UserInfoVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IMService</span> <span class="p">{</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">HuanXinApi</span> <span class="n">huanXinApi</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserInfoService</span> <span class="n">userInfoService</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">UserInfoVo</span> <span class="nf">queryUserInfoByUserName</span><span class="p">(</span><span class="n">String</span> <span class="n">userName</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//查询环信账户</span>
        <span class="n">HuanXinUser</span> <span class="n">huanXinUser</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">queryUserByUserName</span><span class="p">(</span><span class="n">userName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">huanXinUser</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//查询用户信息</span>
        <span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserId</span><span class="p">(</span><span class="n">huanXinUser</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">userInfo</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">UserInfoVo</span> <span class="n">userInfoVo</span> <span class="o">=</span> <span class="n">BeanUtil</span><span class="p">.</span><span class="na">copyProperties</span><span class="p">(</span><span class="n">userInfo</span><span class="p">,</span> <span class="n">UserInfoVo</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="s">&quot;marriage&quot;</span><span class="p">);</span>
        <span class="n">userInfoVo</span><span class="p">.</span><span class="na">setGender</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getSex</span><span class="p">().</span><span class="na">toString</span><span class="p">().</span><span class="na">toLowerCase</span><span class="p">());</span>
        <span class="n">userInfoVo</span><span class="p">.</span><span class="na">setMarriage</span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;已婚&quot;</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getMarriage</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">userInfoVo</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h5 id="8424">8.4.2.4、测试<a class="headerlink" href="#8424" title="Permanent link">&para;</a></h5>
<p><img alt="image-20201230225943923" src="assets/image-20201230225943923.png" /></p>
<h3 id="85id">8.5、根据用户id查询个人信息<a class="headerlink" href="#85id" title="Permanent link">&para;</a></h3>
<p>在消息模块与我的模块中，需要根据用户id查询个人信息，其响应的数据结构与上面一致，均为：UserInfoVo对象。</p>
<p>接口地址：https://mock-java.itheima.net/project/35/interface/api/875</p>
<h4 id="851mycentercontroller">8.5.1、MyCenterController<a class="headerlink" href="#851mycentercontroller" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.controller</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.service.MyCenterService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.UserInfoVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestParam</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;users&quot;</span><span class="p">)</span>
<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCenterController</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MyCenterService</span> <span class="n">myCenterService</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据用户id查询用户信息</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId 用户id，如果为空，表示查询当前登录人的信息</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">UserInfoVo</span><span class="o">&gt;</span> <span class="nf">queryUserInfoByUserId</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;userID&quot;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">UserInfoVo</span> <span class="n">userInfoVo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">myCenterService</span><span class="p">.</span><span class="na">queryUserInfoByUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">userInfoVo</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">userInfoVo</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;根据用户id查询用户信息出错~ userId = &quot;</span> <span class="o">+</span> <span class="n">userId</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="852mycenterservice">8.5.2、MyCenterService<a class="headerlink" href="#852mycenterservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.bean.BeanUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.UserInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.UserInfoVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCenterService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserInfoService</span> <span class="n">userInfoService</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">UserInfoVo</span> <span class="nf">queryUserInfoByUserId</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">//如果查询id为null，就表示查询当前用户信息</span>
            <span class="n">userId</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getId</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">//查询用户信息</span>
        <span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">userInfo</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">UserInfoVo</span> <span class="n">userInfoVo</span> <span class="o">=</span> <span class="n">BeanUtil</span><span class="p">.</span><span class="na">copyProperties</span><span class="p">(</span><span class="n">userInfo</span><span class="p">,</span> <span class="n">UserInfoVo</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="s">&quot;marriage&quot;</span><span class="p">);</span>
        <span class="n">userInfoVo</span><span class="p">.</span><span class="na">setGender</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getSex</span><span class="p">().</span><span class="na">toString</span><span class="p">().</span><span class="na">toLowerCase</span><span class="p">());</span>
        <span class="n">userInfoVo</span><span class="p">.</span><span class="na">setMarriage</span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;已婚&quot;</span><span class="p">,</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getMarriage</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">userInfoVo</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="853">8.5.3、测试<a class="headerlink" href="#853" title="Permanent link">&para;</a></h4>
<p><img alt="image-20201230225943923" src="assets/image-20201230225943923.png" /></p>
<h3 id="86">8.6、发送消息给客户端<a class="headerlink" href="#86" title="Permanent link">&para;</a></h3>
<p>目前已经完成了用户体系的对接，下面我们进行测试发送消息，场景是这样的：</p>
<p><img alt="1570853314493" src="assets/1570853314493.png" /></p>
<p>点击“聊一下”，就会给对方发送一条陌生人信息，这个消息由系统发送完成。</p>
<p>我们暂时通过环信的控制台进行发送： <img alt="1570853400508" src="assets/1570853400508.png" /></p>
<p>消息内容：</p>
<div class="codehilite"><pre><span></span><code><span class="o">{</span><span class="s2">&quot;userId&quot;</span>:1,<span class="s2">&quot;huanXinId&quot;</span>:<span class="s2">&quot;HX_1&quot;</span>,<span class="s2">&quot;nickname&quot;</span>:<span class="s2">&quot;黑马小妹&quot;</span>,<span class="s2">&quot;strangerQuestion&quot;</span>:<span class="s2">&quot;你喜欢去看蔚蓝的大海还是去爬巍峨的高山？&quot;</span>,<span class="s2">&quot;reply&quot;</span>:<span class="s2">&quot;我喜欢秋天的落叶，夏天的泉水，冬天的雪地，只要有你一切皆可~&quot;</span><span class="o">}</span>
</code></pre></div>

<p><img alt="1570853459084" src="assets/1570853459084.png" /></p>
<p><img alt="1570853651822" src="assets/1570853651822.png" /></p>
<p><img alt="1570853668888" src="assets/1570853668888.png" /></p>
<p>可以看到已经接收到了消息。</p>
<h3 id="87">8.7、将用户数据同步到环信<a class="headerlink" href="#87" title="Permanent link">&para;</a></h3>
<p>需要将1~99用户注册到环信，因为我们提供的数据都是这些用户的数据。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.TestHuanXinApi</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRegisterAllUser</span><span class="p">(){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">Long</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p><img alt="image-20210105151927666" src="assets/image-20210105151927666.png" /></p>
<p>环信：</p>
<p><img alt="image-20210105151812294" src="assets/image-20210105151812294.png" /></p>
<h2 id="9">9、 添加联系人<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<p>点击“聊一下”，就会成为联系人（好友）。</p>
<p>实现：</p>
<ul>
<li>将好友写入到MongoDB中</li>
<li>将好友关系注册到环信</li>
</ul>
<p>具体的流程如下：</p>
<p><img alt="image-20201229222115658" src="assets/image-20201229222115658.png" /></p>
<h3 id="91dubbo">9.1、好友dubbo服务<a class="headerlink" href="#91dubbo" title="Permanent link">&para;</a></h3>
<h4 id="911">9.1.1、定义接口<a class="headerlink" href="#911" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.api</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UsersApi</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * 保存好友关系</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId   用户id</span>
<span class="cm">     * @param friendId 好友id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">saveUsers</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">);</span>


    <span class="cm">/**</span>
<span class="cm">     * 删除好友数据</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId   用户id</span>
<span class="cm">     * @param friendId 好友id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">removeUsers</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="912">9.1.2、编写实现<a class="headerlink" href="#912" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.dubbo.server.api</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Users</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.bson.types.ObjectId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Criteria</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Query</span><span class="p">;</span>

<span class="nd">@Service</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsersApiImpl</span> <span class="kd">implements</span> <span class="n">UsersApi</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="p">;</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">saveUsers</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isAllNotEmpty</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">friendId</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 检测是否该好友关系是否存在</span>
        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">Criteria</span>
                <span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">(</span><span class="s">&quot;friendId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">friendId</span><span class="p">));</span>
        <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">count</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">Users</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Users</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Users</span><span class="p">();</span>

        <span class="n">users</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
        <span class="n">users</span><span class="p">.</span><span class="na">setDate</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>
        <span class="n">users</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
        <span class="n">users</span><span class="p">.</span><span class="na">setFriendId</span><span class="p">(</span><span class="n">friendId</span><span class="p">);</span>

        <span class="c1">//注册我与好友的关系</span>
        <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">users</span><span class="p">);</span>

        <span class="c1">//注册好友与我的关系</span>
        <span class="n">users</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
        <span class="n">users</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">friendId</span><span class="p">);</span>
        <span class="n">users</span><span class="p">.</span><span class="na">setFriendId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">users</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">users</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toHexString</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">removeUsers</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Query</span> <span class="n">query1</span> <span class="o">=</span> <span class="n">Query</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">Criteria</span><span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">(</span><span class="s">&quot;friendId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">friendId</span><span class="p">));</span>

        <span class="c1">//删除我与好友的关系数据</span>
        <span class="kt">long</span> <span class="n">count1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">query1</span><span class="p">,</span> <span class="n">Users</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">getDeletedCount</span><span class="p">();</span>

        <span class="n">Query</span> <span class="n">query2</span> <span class="o">=</span> <span class="n">Query</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">Criteria</span><span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">friendId</span><span class="p">)</span>
                <span class="p">.</span><span class="na">and</span><span class="p">(</span><span class="s">&quot;friendId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span>
        <span class="c1">//删除好友与我的关系数据</span>
        <span class="kt">long</span> <span class="n">count2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">query2</span><span class="p">,</span> <span class="n">Users</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">getDeletedCount</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">count1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="92dubbo">9.2、环信dubbo服务<a class="headerlink" href="#92dubbo" title="Permanent link">&para;</a></h3>
<h4 id="921">9.2.1、定义接口<a class="headerlink" href="#921" title="Permanent link">&para;</a></h4>
<p>在my-tanhua-dubbo-interface中定义。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.HuanXinApi</span>

    <span class="cm">/**</span>
<span class="cm">     * 添加好友（双向好友关系）</span>
<span class="cm">     * 参见：http://docs-im.easemob.com/im/server/ready/user#%E6%B7%BB%E5%8A%A0%E5%A5%BD%E5%8F%8B</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId   自己的id</span>
<span class="cm">     * @param friendId 好友的id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">addUserFriend</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * 删除好友关系（双向删除）</span>
<span class="cm">     * 参见：http://docs-im.easemob.com/im/server/ready/user#%E7%A7%BB%E9%99%A4%E5%A5%BD%E5%8F%8B</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId   自己的id</span>
<span class="cm">     * @param friendId 好友的id</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">Boolean</span> <span class="nf">removeUserFriend</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">);</span>
</code></pre></div>

<h4 id="922">9.2.2、编写实现<a class="headerlink" href="#922" title="Permanent link">&para;</a></h4>
<p>在my-tanhua-dubbo-huanxin中实现。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.HuanXinApiImpl</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">addUserFriend</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getUrl</span><span class="p">()</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getOrgName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getAppName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/users/HX_&quot;</span> <span class="o">+</span>
                <span class="n">userId</span> <span class="o">+</span> <span class="s">&quot;/contacts/users/HX_&quot;</span> <span class="o">+</span> <span class="n">friendId</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// 404 -&gt; 对方未在环信注册</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">requestService</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUrl</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">Method</span><span class="p">.</span><span class="na">POST</span><span class="p">).</span><span class="na">isOk</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// 添加失败</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">removeUserFriend</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Long</span> <span class="n">friendId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">String</span> <span class="n">targetUrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getUrl</span><span class="p">()</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getOrgName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
                <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinConfig</span><span class="p">.</span><span class="na">getAppName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/users/HX_&quot;</span> <span class="o">+</span>
                <span class="n">userId</span> <span class="o">+</span> <span class="s">&quot;/contacts/users/HX_&quot;</span> <span class="o">+</span> <span class="n">friendId</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// 404 -&gt; 对方未在环信注册</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">requestService</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">targetUrl</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">Method</span><span class="p">.</span><span class="na">DELETE</span><span class="p">).</span><span class="na">isOk</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// 添加失败</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="93app">9.3、APP接口服务<a class="headerlink" href="#93app" title="Permanent link">&para;</a></h3>
<p>接口地址：https://mock-java.itheima.net/project/35/interface/api/809</p>
<p>在my-tanhua-server中完成。</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.controller.IMController</span>

    <span class="cm">/**</span>
<span class="cm">     * 添加好友</span>
<span class="cm">     *</span>
<span class="cm">     * @param param</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;contacts&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">contactUser</span><span class="p">(</span><span class="nd">@RequestBody</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">param</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Long</span> <span class="n">friendId</span> <span class="o">=</span> <span class="n">Long</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">).</span><span class="na">toString</span><span class="p">());</span>
            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">imService</span><span class="p">.</span><span class="na">contactUser</span><span class="p">(</span><span class="n">friendId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;添加联系人失败! param = &quot;</span> <span class="o">+</span> <span class="n">param</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.HuanXinApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.UsersApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IMService</span> <span class="p">{</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">UsersApi</span> <span class="n">usersApi</span><span class="p">;</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">HuanXinApi</span> <span class="n">huanXinApi</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 添加好友</span>
<span class="cm">     *</span>
<span class="cm">     * @param friendId 好友id</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contactUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">friendId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">String</span> <span class="n">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">usersApi</span><span class="p">.</span><span class="na">saveUsers</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">friendId</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">//注册好友关系到环信</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">huanXinApi</span><span class="p">.</span><span class="na">addUserFriend</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">friendId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="94">9.4、测试<a class="headerlink" href="#94" title="Permanent link">&para;</a></h3>
<p>接口测试：</p>
<p><img alt="image-20210105162343933" src="assets/image-20210105162343933.png" /></p>
<p>Monodb数据：</p>
<p><img alt="image-20210105162412000" src="assets/image-20210105162412000.png" /></p>
<p>环信平台好友数据：</p>
<p><img alt="image-20210105162436620" src="assets/image-20210105162436620.png" /></p>
<h3 id="95">9.5、重新生成好友关系数据<a class="headerlink" href="#95" title="Permanent link">&para;</a></h3>
<p>由于之前的数据并没有完整的双向数据，所以需要重新生成，如下：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.RandomUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.service.IMService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="p">;</span>

<span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestIMService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IMService</span> <span class="n">imService</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 构造好友数据，为1~99用户构造10个好友</span>
<span class="cm">     */</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUsers</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">99</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">();</span>
                <span class="n">user</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toLong</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="na">imService</span><span class="p">.</span><span class="na">contactUser</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getFriendId</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="n">Long</span> <span class="nf">getFriendId</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Long</span> <span class="n">friendId</span> <span class="o">=</span> <span class="n">RandomUtil</span><span class="p">.</span><span class="na">randomLong</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">friendId</span><span class="p">.</span><span class="na">intValue</span><span class="p">()</span> <span class="o">==</span> <span class="n">userId</span><span class="p">.</span><span class="na">intValue</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">getFriendId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">friendId</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="10">10、联系人列表<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<p>用户在消息模块中，可以查看联系人列表（好友列表）。</p>
<p>接口文档地址：https://mock-java.itheima.net/project/35/interface/api/803</p>
<h3 id="101dubbo">10.1、dubbo服务<a class="headerlink" href="#101dubbo" title="Permanent link">&para;</a></h3>
<h4 id="1011">10.1.1、定义接口<a class="headerlink" href="#1011" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.UsersApi</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据用户id查询全部Users列表</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="nf">queryAllUsersList</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据用户id查询Users列表(分页查询)</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="nf">queryUsersList</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">);</span>
</code></pre></div>

<h4 id="1012">10.1.2、接口实现<a class="headerlink" href="#1012" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.dubbo.server.api.UsersApiImpl</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="nf">queryAllUsersList</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">Criteria</span><span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">Users</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="nf">queryUsersList</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PageRequest</span> <span class="n">pageRequest</span> <span class="o">=</span> <span class="n">PageRequest</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">,</span> <span class="n">Sort</span><span class="p">.</span><span class="na">by</span><span class="p">(</span><span class="n">Sort</span><span class="p">.</span><span class="na">Order</span><span class="p">.</span><span class="na">desc</span><span class="p">(</span><span class="s">&quot;created&quot;</span><span class="p">)));</span>
        <span class="n">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">.</span><span class="na">query</span><span class="p">(</span><span class="n">Criteria</span><span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="n">userId</span><span class="p">)).</span><span class="na">with</span><span class="p">(</span><span class="n">pageRequest</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="n">usersList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">Users</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageInfo</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">pageInfo</span><span class="p">.</span><span class="na">setPageNum</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageInfo</span><span class="p">.</span><span class="na">setPageSize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>
        <span class="n">pageInfo</span><span class="p">.</span><span class="na">setRecords</span><span class="p">(</span><span class="n">usersList</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">pageInfo</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="102app">10.2、APP接口服务<a class="headerlink" href="#102app" title="Permanent link">&para;</a></h3>
<h4 id="1021usersvo">10.2.1、UsersVo<a class="headerlink" href="#1021usersvo" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.vo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsersVo</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userId</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">avatar</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nickname</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">gender</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">age</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">city</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div>

<h4 id="1022imcontroller">10.2.2、IMController<a class="headerlink" href="#1022imcontroller" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.controller.IMController</span>

    <span class="cm">/**</span>
<span class="cm">     * 查询联系人列表</span>
<span class="cm">     *</span>
<span class="cm">     * @param page</span>
<span class="cm">     * @param pageSize</span>
<span class="cm">     * @param keyword</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;contacts&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">PageResult</span><span class="o">&gt;</span> <span class="nf">queryContactsList</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span>
                                                        <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;pagesize&quot;</span><span class="p">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;10&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">,</span>
                                                        <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;keyword&quot;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="n">String</span> <span class="n">keyword</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">imService</span><span class="p">.</span><span class="na">queryContactsList</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">,</span> <span class="n">keyword</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">pageResult</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="1023imservice">10.2.3、IMService<a class="headerlink" href="#1023imservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">//com.tanhua.server.service.IMService</span>

    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryContactsList</span><span class="p">(</span><span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">,</span> <span class="n">String</span> <span class="n">keyword</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="n">usersList</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">keyword</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">//关键不为空，查询所有的好友，在后面进行关键字过滤</span>
            <span class="n">usersList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">usersApi</span><span class="p">.</span><span class="na">queryAllUsersList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//关键字为空，进行分页查询</span>
            <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Users</span><span class="o">&gt;</span> <span class="n">usersPageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">usersApi</span><span class="p">.</span><span class="na">queryUsersList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
            <span class="n">usersList</span> <span class="o">=</span> <span class="n">usersPageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">usersList</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">usersList</span><span class="p">,</span> <span class="s">&quot;friendId&quot;</span><span class="p">);</span>

        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">queryWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">queryWrapper</span><span class="p">.</span><span class="na">in</span><span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">userIds</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">keyword</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">queryWrapper</span><span class="p">.</span><span class="na">like</span><span class="p">(</span><span class="s">&quot;nick_name&quot;</span><span class="p">,</span> <span class="n">keyword</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoList</span><span class="p">(</span><span class="n">queryWrapper</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">UsersVo</span><span class="o">&gt;</span> <span class="n">contactsList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="c1">//填充用户信息</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">UsersVo</span> <span class="n">usersVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsersVo</span><span class="p">();</span>
            <span class="n">usersVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
            <span class="n">usersVo</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getAge</span><span class="p">());</span>
            <span class="n">usersVo</span><span class="p">.</span><span class="na">setAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getLogo</span><span class="p">());</span>
            <span class="n">usersVo</span><span class="p">.</span><span class="na">setGender</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getSex</span><span class="p">().</span><span class="na">name</span><span class="p">().</span><span class="na">toLowerCase</span><span class="p">());</span>
            <span class="n">usersVo</span><span class="p">.</span><span class="na">setNickname</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span>
            <span class="c1">//环信用户账号</span>
            <span class="n">usersVo</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="s">&quot;HX_&quot;</span> <span class="o">+</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()));</span>
            <span class="n">usersVo</span><span class="p">.</span><span class="na">setCity</span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">substringBefore</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getCity</span><span class="p">(),</span> <span class="s">&quot;-&quot;</span><span class="p">));</span>
            <span class="n">contactsList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">usersVo</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="n">contactsList</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="103">10.3、测试<a class="headerlink" href="#103" title="Permanent link">&para;</a></h3>
<p><img alt="image-20201229234205482" src="assets/image-20201229234205482.png" /></p>
<p><img alt="image-20201229234325279" src="assets/image-20201229234325279.png" /></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../day05/" class="md-footer__link md-footer__link--prev" aria-label="上一页: day05" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              day05
            </div>
          </div>
        </a>
      
      
        
        <a href="../day07/" class="md-footer__link md-footer__link--next" aria-label="下一页: day07" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              day07
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019 peaceiris
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/peaceiris" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/piris314en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>