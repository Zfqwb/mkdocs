
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="MkDocs Material Boilerplate (Starter Kit) - Deploy documentation to hosting platforms (Netlify, GitHub Pages, GitLab Pages, and AWS Amplify Console) with Docker, pipenv, and GitHub Actions.">
      
      
      
        <meta name="author" content="nitto">
      
      
        <link rel="canonical" href="https://nitto.netlify.app/tantan/day10/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>day10 - Nitto Java Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
      <link rel="manifest" href="../../manifest.json" crossorigin="use-credentials">
    
    
      <link rel="stylesheet" href="../../assets/css/custom.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Nitto Java Docs" class="md-header__button md-logo" aria-label="Nitto Java Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nitto Java Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              day10
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/Zfqwb/mkdocs/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Nitto Java Docs" class="md-nav__button md-logo" aria-label="Nitto Java Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Nitto Java Docs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Zfqwb/mkdocs/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../MySQL/" class="md-nav__link">
        Mysql
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../jquery/" class="md-nav__link">
        JQuery
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../ajax/" class="md-nav__link">
        AJAX
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Redis
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Redis" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/day01/" class="md-nav__link">
        day01
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/day02/" class="md-nav__link">
        day02
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Docker
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Docker" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/1/" class="md-nav__link">
        初识 Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/2/" class="md-nav__link">
        docker命令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/3/" class="md-nav__link">
        docker容器的数据卷
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/4/" class="md-nav__link">
        docker部署容器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/5/" class="md-nav__link">
        Docerfile
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/6/" class="md-nav__link">
        服务编排
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/7/" class="md-nav__link">
        私有仓库
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../MongoDB/MongoDB/" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      <label class="md-nav__link" for="__nav_8">
        项目一-探花交友
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="项目一-探花交友" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          项目一-探花交友
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day01/" class="md-nav__link">
        day01
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day02/" class="md-nav__link">
        day02
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day03/" class="md-nav__link">
        day03
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day04/" class="md-nav__link">
        day04
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day05/" class="md-nav__link">
        day05
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day06/" class="md-nav__link">
        day06
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day07/" class="md-nav__link">
        day07
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day08/" class="md-nav__link">
        day08
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../day09/" class="md-nav__link">
        day09
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          day10
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        day10
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    课程说明
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、了解推荐系统
  </a>
  
    <nav class="md-nav" aria-label="1、了解推荐系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1、什么是推荐系统？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    1.2、电商是推荐系统的先行者
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    1.3、推荐系统业务流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14" class="md-nav__link">
    1.4、协同过滤推荐算法
  </a>
  
    <nav class="md-nav" aria-label="1.4、协同过滤推荐算法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#141_usercf" class="md-nav__link">
    1.4.1、基于用户的推荐 UserCF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#142_itemcf" class="md-nav__link">
    1.4.2、基于商品的推荐 ItemCF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15als" class="md-nav__link">
    1.5、ALS算法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、好友推荐
  </a>
  
    <nav class="md-nav" aria-label="2、好友推荐">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    2.1、流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    2.2、部署好友推荐服务
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、圈子推荐
  </a>
  
    <nav class="md-nav" aria-label="3、圈子推荐">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    3.1、功能说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    3.2、流程说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    3.3、动态计分规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    3.4、发送消息
  </a>
  
    <nav class="md-nav" aria-label="3.4、发送消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#341quanzimqservice" class="md-nav__link">
    3.4.1、QuanziMQService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#342quanziservice" class="md-nav__link">
    3.4.2、修改QuanZiService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    3.5、接收消息
  </a>
  
    <nav class="md-nav" aria-label="3.5、接收消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#351my-tanhua-recommend" class="md-nav__link">
    3.5.1、创建my-tanhua-recommend工程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#352" class="md-nav__link">
    3.5.2、配置文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#353" class="md-nav__link">
    3.5.3、启动类
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#354recommendquanzi" class="md-nav__link">
    3.5.4、RecommendQuanZi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#355quanzimsgconsumer" class="md-nav__link">
    3.5.5、QuanZiMsgConsumer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17" class="md-nav__link">
    1.7、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、部署推荐系统
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、小视频推荐
  </a>
  
    <nav class="md-nav" aria-label="5、小视频推荐">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1、动态计分规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2、发送消息
  </a>
  
    <nav class="md-nav" aria-label="5.2、发送消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#521videomqservice" class="md-nav__link">
    5.2.1、VideoMQService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432videoservice" class="md-nav__link">
    4.3.2、VideoService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53" class="md-nav__link">
    5.3、接收消息
  </a>
  
    <nav class="md-nav" aria-label="5.3、接收消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#531recommendvideo" class="md-nav__link">
    5.3.1、RecommendVideo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#532videomsgconsumer" class="md-nav__link">
    5.3.2、VideoMsgConsumer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#533" class="md-nav__link">
    5.3.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54" class="md-nav__link">
    5.4、部署推荐服务
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_11" type="checkbox" id="__nav_8_11" >
      
      <label class="md-nav__link" for="__nav_8_11">
        补充资料
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="补充资料" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_11">
          <span class="md-nav__icon md-icon"></span>
          补充资料
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/lombok/" class="md-nav__link">
        day01_lombok
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/mybatisPlus/" class="md-nav__link">
        day01_mybatis_plus
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/aliyun/" class="md-nav__link">
        day01_阿里云
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/sso/" class="md-nav__link">
        day01_单点登录及jwt
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/nginx/" class="md-nav__link">
        day03_nginx
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/threadlocal/README.md" class="md-nav__link">
        day03_ThreadLocal
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/mongodb/" class="md-nav__link">
        day04_MongoDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../further/ansy/" class="md-nav__link">
        day04_多线程@Ansy
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      <label class="md-nav__link" for="__nav_9">
        面试
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          面试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interview/e.g.1.0.0/" class="md-nav__link">
        e.g.1.0.0
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    课程说明
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、了解推荐系统
  </a>
  
    <nav class="md-nav" aria-label="1、了解推荐系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    1.1、什么是推荐系统？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    1.2、电商是推荐系统的先行者
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    1.3、推荐系统业务流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14" class="md-nav__link">
    1.4、协同过滤推荐算法
  </a>
  
    <nav class="md-nav" aria-label="1.4、协同过滤推荐算法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#141_usercf" class="md-nav__link">
    1.4.1、基于用户的推荐 UserCF
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#142_itemcf" class="md-nav__link">
    1.4.2、基于商品的推荐 ItemCF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15als" class="md-nav__link">
    1.5、ALS算法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2、好友推荐
  </a>
  
    <nav class="md-nav" aria-label="2、好友推荐">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    2.1、流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    2.2、部署好友推荐服务
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、圈子推荐
  </a>
  
    <nav class="md-nav" aria-label="3、圈子推荐">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    3.1、功能说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    3.2、流程说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    3.3、动态计分规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    3.4、发送消息
  </a>
  
    <nav class="md-nav" aria-label="3.4、发送消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#341quanzimqservice" class="md-nav__link">
    3.4.1、QuanziMQService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#342quanziservice" class="md-nav__link">
    3.4.2、修改QuanZiService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    3.5、接收消息
  </a>
  
    <nav class="md-nav" aria-label="3.5、接收消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#351my-tanhua-recommend" class="md-nav__link">
    3.5.1、创建my-tanhua-recommend工程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#352" class="md-nav__link">
    3.5.2、配置文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#353" class="md-nav__link">
    3.5.3、启动类
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#354recommendquanzi" class="md-nav__link">
    3.5.4、RecommendQuanZi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#355quanzimsgconsumer" class="md-nav__link">
    3.5.5、QuanZiMsgConsumer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17" class="md-nav__link">
    1.7、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、部署推荐系统
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5、小视频推荐
  </a>
  
    <nav class="md-nav" aria-label="5、小视频推荐">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    5.1、动态计分规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2、发送消息
  </a>
  
    <nav class="md-nav" aria-label="5.2、发送消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#521videomqservice" class="md-nav__link">
    5.2.1、VideoMQService
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432videoservice" class="md-nav__link">
    4.3.2、VideoService
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53" class="md-nav__link">
    5.3、接收消息
  </a>
  
    <nav class="md-nav" aria-label="5.3、接收消息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#531recommendvideo" class="md-nav__link">
    5.3.1、RecommendVideo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#532videomsgconsumer" class="md-nav__link">
    5.3.2、VideoMsgConsumer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#533" class="md-nav__link">
    5.3.3、测试
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54" class="md-nav__link">
    5.4、部署推荐服务
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Zfqwb/mkdocs/edit/main/docs_sample/tantan/day10/README.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>day10</h1>
                
                <h2 id="_1">课程说明<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>了解推荐系统</li>
<li>实现好友的推荐</li>
<li>圈子推荐功能说明</li>
<li>圈子推荐功能流程</li>
<li>圈子推荐功能的实现</li>
<li>小视频推荐功能的实现</li>
</ul>
<h2 id="1">1、了解推荐系统<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1、什么是推荐系统？<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<p><strong>为了解决信息过载和用户无明确需求的问题，找到用户感兴趣的物品，才有了个性化推荐系统。</strong></p>
<p>其实，解决信息过载的问题，代表性的解决方案是分类目录和搜索引擎，如hao123，电商首页的分类目录以及百度，360搜索等。</p>
<p>不过分类目录和搜索引擎只能解决用户主动查找信息的需求，即用户知道自己想要什么，并不能解决用户没用明确需求很随便的问题。</p>
<p>经典语录是：你想吃什么，随便！面对这种很随便又得罪不起的用户（女友和上帝），只能<strong>通过分析用户的历史行为给用户的兴趣建模</strong>，从而主动给用户推荐能够满足他们兴趣和需求的信息。比如问问女友的闺蜜，她一般什么时候喜欢吃什么。</p>
<h3 id="12">1.2、电商是推荐系统的先行者<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] 电子商务网站是个性化推荐系统重要地应用的领域之一，亚马逊就是个性化推荐系统的积极应用者和推广者，亚马逊的推荐系统深入到网站的各类商品，为亚马逊带来了至少30%的销售额。</li>
<li>[ ] 不光是电商类，推荐系统无处不在。QQ，微信的好友推荐；新浪微博的你可能感兴趣的人；优酷，土豆的电影推荐；豆瓣的图书推荐；大从点评的餐饮推荐；脉脉的同事推荐等。</li>
<li>[ ] 推荐引擎的鼻祖思想源泉：http://portal.acm.org/citation.cfm?id=1070751</li>
<li>[ ] 亚马逊最早提出基亍物品的协同过滤推荐算法：http://portal.acm.org/citation.cfm?id=372071</li>
</ul>
<p>京东的推荐： <img alt="1533027301281" src="assets/1533027301281.png" /></p>
<h3 id="13">1.3、推荐系统业务流程<a class="headerlink" href="#13" title="Permanent link">&para;</a></h3>
<p><img alt="1533027789007" src="assets/1533027789007.png" /></p>
<p>推荐系统广泛存在于各类网站中，作为一个应用为用户提供个性化的推荐。它需要一些用户的历史数据，一般由三个部分组成：基础数据、推荐算法系统、前台展示。</p>
<ul>
<li>基础数据包括很多维度，包括用户的访问、浏览、下单、收藏，用户的历史订单信息，评价信息等很多信息；</li>
<li>推荐算法系统主要是根据不同的推荐诉求由多个算法组成的推荐模型；</li>
<li>前台展示主要是对客户端系统进行响应，返回相关的推荐信息以供展示。</li>
</ul>
<h3 id="14">1.4、协同过滤推荐算法<a class="headerlink" href="#14" title="Permanent link">&para;</a></h3>
<p>迄今为止，在个性化推荐系统中，协同过滤技术是应用最成功的技术。目前国内外有许多大型网站应用这项技术为用户更加智能（个性化、千人千面）的推荐内容。</p>
<blockquote>
<p>核心思想：</p>
<p>协同过滤一般是在海量的用户中发掘出一小部分和你品位比较类似的，在协同过滤中，这些用户成为邻居，然后根据他们喜欢的其他东西组织成一个排序的目彔作为推荐给你。
</p>
</blockquote>
<h4 id="141_usercf">1.4.1、基于用户的推荐 UserCF<a class="headerlink" href="#141_usercf" title="Permanent link">&para;</a></h4>
<p><img alt="1533029239312" src="assets/1533029239312.png" /></p>
<p><img alt="1533029506213" src="assets/1533029506213-1611629706240.png" /></p>
<p>对于用户A，根据用户的历史偏好，这里只计算得到一个邻居–用户C，然后将用户C 喜欢的物品D 推荐给用户A。</p>
<p>基于用户的协同过滤算法先计算的是用户与用户的相似度（兴趣相投，物以类聚人以群分），然后将相似度比较接近的用户A购买的物品推荐给用户B，专业的说法是该算法用最近邻居（nearest-neighbor）算法找出一个用户的邻居集合，该集合的用户和该用户有相似的喜好，算法根据邻居的偏好对该用户进行预测。</p>
<h4 id="142_itemcf">1.4.2、基于商品的推荐 ItemCF<a class="headerlink" href="#142_itemcf" title="Permanent link">&para;</a></h4>
<p><img alt="1533042920915" src="assets/1533042920915.png" /></p>
<ul>
<li>基于ItemCF的原理和基于UserCF类似，只是在计算邻居时采用物品本身，而不是从用户的角度，即基于用户对物品的偏好找到相似的物品，然后根据用户的历史偏好，推荐相似的物品给他。</li>
<li>从计算的角度看，就是将所有用户对某个物品的偏好作为一个向量来计算物品之间的相似度，得到物品的相似物品后，根据用户历史的偏好预测当前用户还没有表示偏好的物品，计算得到一个排序的物品列表作为推荐。</li>
<li>解释：对于物品A，根据所有用户的历史偏好，喜欢物品A 的用户都喜欢物品C，得出物品A 和物品C 比较相似，而用户C 喜欢物品A，那么可以推断出用户C 可能也喜欢物品C。</li>
</ul>
<h3 id="15als">1.5、ALS算法<a class="headerlink" href="#15als" title="Permanent link">&para;</a></h3>
<p>ALS 是交替最小二乘 （alternating least squares）的简称。在机器学习的上下文中，ALS 特指使用交替最小二乘求解的一个协同推荐算法。它通过观察到的所有用户给产品的打分，来推断每个用户的喜好并向用户推荐适合的产品。从协同过滤的分类来说，ALS算法属于User-Item CF，也叫做混合CF。它同时考虑了User和Item两个方面。</p>
<p>用户和商品的关系，可以抽象为如下的三元组：<User,Item,Rating>。其中，Rating是用户对商品的评分，表征用户对该商品的喜好程度。如下：</p>
<div class="codehilite"><pre><span></span><code><span class="m">196</span> <span class="m">242</span> <span class="m">3</span>   <span class="m">881250949</span>
<span class="m">186</span> <span class="m">302</span> <span class="m">3</span>   <span class="m">891717742</span>
<span class="m">22</span>  <span class="m">377</span> <span class="m">1</span>   <span class="m">878887116</span>
<span class="m">244</span> <span class="m">51</span>  <span class="m">2</span>   <span class="m">880606923</span>
<span class="m">166</span> <span class="m">346</span> <span class="m">1</span>   <span class="m">886397596</span>
<span class="m">298</span> <span class="m">474</span> <span class="m">4</span>   <span class="m">884182806</span>
<span class="m">115</span> <span class="m">265</span> <span class="m">2</span>   <span class="m">881171488</span>
<span class="m">253</span> <span class="m">465</span> <span class="m">5</span>   <span class="m">891628467</span>
<span class="m">305</span> <span class="m">451</span> <span class="m">3</span>   <span class="m">886324817</span>
<span class="m">6</span>   <span class="m">86</span>  <span class="m">3</span>   <span class="m">883603013</span>
<span class="m">62</span>  <span class="m">257</span> <span class="m">2</span>   <span class="m">879372434</span>
<span class="m">286</span> <span class="m">1014</span>    <span class="m">5</span>   <span class="m">879781125</span>
<span class="m">200</span> <span class="m">222</span> <span class="m">5</span>   <span class="m">876042340</span>
<span class="m">210</span> <span class="m">40</span>  <span class="m">3</span>   <span class="m">891035994</span>
................
</code></pre></div>

<h2 id="2">2、好友推荐<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<p>对于好友的推荐，需要找出每个用户之间的相似性，具体规则如下：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>权重分</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>年龄差</td>
<td>0-2岁 30分</td>
<td>3-5 20分</td>
<td>5-10岁 10分</td>
<td>10岁以上 0分</td>
</tr>
<tr>
<td>性别</td>
<td>异性 30分</td>
<td>同性 0分</td>
<td></td>
<td></td>
</tr>
<tr>
<td>位置</td>
<td>同城 20分</td>
<td>不同 0分</td>
<td></td>
<td></td>
</tr>
<tr>
<td>学历</td>
<td>相同 20分</td>
<td>不同 0分</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="21">2.1、流程<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<p><img alt="image-20210127101912885" src="assets/image-20210127101912885.png" /></p>
<h3 id="22">2.2、部署好友推荐服务<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">#拉取镜像</span>
docker pull registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-recommend-user:1.0.1

<span class="c1">#创建容器</span>
docker create --name tanhua-spark-recommend-user <span class="se">\</span>
--env <span class="nv">MONGODB_HOST</span><span class="o">=</span><span class="m">192</span>.168.31.81 <span class="se">\</span>
--env <span class="nv">MONGODB_PORT</span><span class="o">=</span><span class="m">27017</span> <span class="se">\</span>
--env <span class="nv">MONGODB_USERNAME</span><span class="o">=</span>tanhua <span class="se">\</span>
--env <span class="nv">MONGODB_PASSWORD</span><span class="o">=</span>l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV <span class="se">\</span>
--env <span class="nv">MONGODB_DATABASE</span><span class="o">=</span>tanhua <span class="se">\</span>
--env <span class="nv">MONGODB_COLLECTION</span><span class="o">=</span>recommend_user <span class="se">\</span>
--env <span class="nv">JDBC_URL</span><span class="o">=</span><span class="s2">&quot;jdbc:mysql://192.168.31.81:3306/mytanhua?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false&quot;</span> <span class="se">\</span>
--env <span class="nv">JDBC_DRIVER</span><span class="o">=</span>com.mysql.jdbc.Driver <span class="se">\</span>
--env <span class="nv">JDBC_USER</span><span class="o">=</span>root <span class="se">\</span>
--env <span class="nv">JDBC_PASSWORD</span><span class="o">=</span>root <span class="se">\</span>
--env <span class="nv">JDBC_TABLE</span><span class="o">=</span>tb_user_info <span class="se">\</span>
--env <span class="nv">SCHEDULE_PERIOD</span><span class="o">=</span><span class="m">30</span> <span class="se">\</span>
registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-recommend-user:1.0.1

<span class="c1">#参数说明</span>
<span class="c1">#MONGODB_HOST mongodb服务的地址</span>
<span class="c1">#MONGODB_PORT mongodb服务的端口</span>
<span class="c1">#MONGODB_USERNAME mongodb服务的认证用户名</span>
<span class="c1">#MONGODB_PASSWORD mongodb服务的认证密码</span>
<span class="c1">#MONGODB_DATABASE mongodb连接的数据库</span>
<span class="c1">#MONGODB_COLLECTION 操作表</span>
<span class="c1">#JDBC_URL  mysql数据库连接地址</span>
<span class="c1">#JDBC_DRIVER  jdbc驱动</span>
<span class="c1">#JDBC_USER  数据库连接用户名</span>
<span class="c1">#JDBC_PASSWORD  数据库连接密码</span>
<span class="c1">#JDBC_TABLE  数据库表名</span>
<span class="c1">#SCHEDULE_PERIOD  下次执行时间间隔，但是为分，默认为10分钟</span>

<span class="c1">#启动服务</span>
docker start tanhua-spark-recommend-user
<span class="c1">#查看日志</span>
docker logs -f tanhua-spark-recommend-user
</code></pre></div>

<p>执行完成后，可以看到MongoDB中的recommend_user表中数据已经重新生成了。</p>
<h2 id="3">3、圈子推荐<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1、功能说明<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<p>在圈子功能中，针对于用户发布的动态信息，系统可以根据用户的发布、浏览、点赞等操作，对动态信息做计算，然后对每个用户进行不同的推荐。</p>
<h3 id="32">3.2、流程说明<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<p><img alt="image-20210126143347337" src="assets/image-20210126143347337.png" /></p>
<p>流程说明：</p>
<ul>
<li>用户对圈子的动态操作，如：发布、浏览、点赞、喜欢等，就会给RocketMQ进行发送消息；</li>
<li>推荐系统接收消息，并且处理消息数据，处理之后将结果数据写入到MongoDB中；</li>
<li>Spark系统拉取数据，然后进行推荐计算；</li>
<li>计算之后的结果数据写入到Redis中，为每个用户都进行个性化推荐；</li>
</ul>
<h3 id="33">3.3、动态计分规则<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<ul>
<li>浏览 +1</li>
<li>点赞 +5</li>
<li>喜欢 +8</li>
<li>评论 + 10</li>
<li>发布动态</li>
<li>文字长度：50以内1分，50~100之间2分，100以上3分</li>
<li>图片个数：每个图片一分</li>
</ul>
<p>核心推荐逻辑：</p>
<ul>
<li>推荐模型：用户 |  动态  | 评分</li>
<li>其中，评分是用户对动态操作的得分合计</li>
<li>为什么自己发布动态还要计分？ 是因为，自己发布就相当于自己对此动态也感兴趣，这样就可以在相似的人之间进行推荐了。</li>
</ul>
<h3 id="34">3.4、发送消息<a class="headerlink" href="#34" title="Permanent link">&para;</a></h3>
<h4 id="341quanzimqservice">3.4.1、QuanziMQService<a class="headerlink" href="#341quanzimqservice" title="Permanent link">&para;</a></h4>
<p>my-tanhua-server增加依赖：</p>
<div class="codehilite"><pre><span></span><code><span class="c">&lt;!--RocketMQ相关--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.rocketmq<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>rocketmq-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.rocketmq<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>rocketmq-client<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>

<p>配置文件：</p>
<div class="codehilite"><pre><span></span><code><span class="c"># RocketMQ相关配置</span>
<span class="na">rocketmq.name-server</span><span class="o">=</span><span class="s">192.168.31.81:9876</span>
<span class="na">rocketmq.producer.group</span><span class="o">=</span><span class="s">tanhua</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.QuanZiApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Publish</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.spring.core.RocketMQTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuanziMQService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">RocketMQTemplate</span> <span class="n">rocketMQTemplate</span><span class="p">;</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">QuanZiApi</span> <span class="n">quanZiApi</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 发布动态消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">publishMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 浏览动态消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">queryPublishMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 点赞动态消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">likePublishMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消点赞动态消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">disLikePublishMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 喜欢动态消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">lovePublishMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消喜欢动态消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">disLovePublishMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 评论动态消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">commentPublishMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 发送圈子操作相关的消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @param type      1-发动态，2-浏览动态， 3-点赞， 4-喜欢， 5-评论，6-取消点赞，7-取消喜欢</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="nf">sendMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

            <span class="n">Publish</span> <span class="n">publish</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryPublishById</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>

            <span class="c1">//构建消息</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;publishId&quot;</span><span class="p">,</span> <span class="n">publishId</span><span class="p">);</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;pid&quot;</span><span class="p">,</span> <span class="n">publish</span><span class="p">.</span><span class="na">getPid</span><span class="p">());</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="na">rocketMQTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;tanhua-quanzi&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;发送消息失败! publishId = &quot;</span> <span class="o">+</span> <span class="n">publishId</span> <span class="o">+</span> <span class="s">&quot;, type = &quot;</span> <span class="o">+</span> <span class="n">type</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="342quanziservice">3.4.2、修改QuanZiService<a class="headerlink" href="#342quanziservice" title="Permanent link">&para;</a></h4>
<p>在QuanZiService完成发送消息方法调用。</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.bean.BeanUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.date.DateUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.UserInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.service.PicUploadService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.RelativeDateFormat</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.vo.PicUploadResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.QuanZiApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.VisitorsApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Comment</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Publish</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Visitors</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.vo.PageInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.CommentVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.PageResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.QuanZiVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.VisitorsVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.lang3.StringUtils</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.multipart.MultipartFile</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.*</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuanZiService</span> <span class="p">{</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">QuanZiApi</span> <span class="n">quanZiApi</span><span class="p">;</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">VisitorsApi</span> <span class="n">visitorsApi</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserService</span> <span class="n">userService</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserInfoService</span> <span class="n">userInfoService</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">PicUploadService</span> <span class="n">picUploadService</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">QuanziMQService</span> <span class="n">quanziMQService</span><span class="p">;</span>

    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryPublishList</span><span class="p">(</span><span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//分析：通过dubbo中的服务查询用户的好友动态</span>
        <span class="c1">//通过mysql查询用户的信息，回写到结果对象中（QuanZiVo）</span>

        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="c1">//直接从ThreadLocal中获取对象</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="c1">//通过dubbo查询数据</span>
        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Publish</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryPublishList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Publish</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">records</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">fillQuanZiVo</span><span class="p">(</span><span class="n">records</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 填充用户信息</span>
<span class="cm">     *</span>
<span class="cm">     * @param userInfo</span>
<span class="cm">     * @param quanZiVo</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">fillUserInfoToQuanZiVo</span><span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span><span class="p">,</span> <span class="n">QuanZiVo</span> <span class="n">quanZiVo</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">BeanUtil</span><span class="p">.</span><span class="na">copyProperties</span><span class="p">(</span><span class="n">userInfo</span><span class="p">,</span> <span class="n">quanZiVo</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">);</span>
        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setGender</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getSex</span><span class="p">().</span><span class="na">name</span><span class="p">().</span><span class="na">toLowerCase</span><span class="p">());</span>
        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setTags</span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getTags</span><span class="p">(),</span> <span class="sc">&#39;,&#39;</span><span class="p">));</span>

        <span class="c1">//当前用户</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setCommentCount</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//TODO 评论数</span>
        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setDistance</span><span class="p">(</span><span class="s">&quot;1.2公里&quot;</span><span class="p">);</span> <span class="c1">//TODO 距离</span>
        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setHasLiked</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryUserIsLike</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">quanZiVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否点赞（1是，0否）</span>
        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setLikeCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">quanZiVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span> <span class="c1">//点赞数</span>
        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setHasLoved</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryUserIsLove</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">quanZiVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否喜欢（1是，0否）</span>
        <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setLoveCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLoveCount</span><span class="p">(</span><span class="n">quanZiVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span> <span class="c1">//喜欢数</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 根据查询到的publish集合填充QuanZiVo对象</span>
<span class="cm">     *</span>
<span class="cm">     * @param records</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">QuanZiVo</span><span class="o">&gt;</span> <span class="nf">fillQuanZiVo</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Publish</span><span class="o">&gt;</span> <span class="n">records</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">QuanZiVo</span><span class="o">&gt;</span> <span class="n">quanZiVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">records</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">publish</span> <span class="o">-&gt;</span> <span class="p">{</span>
            <span class="n">QuanZiVo</span> <span class="n">quanZiVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QuanZiVo</span><span class="p">();</span>
            <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toHexString</span><span class="p">());</span>
            <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setTextContent</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getText</span><span class="p">());</span>
            <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setImageContent</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getMedias</span><span class="p">().</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]</span><span class="p">{}));</span>
            <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
            <span class="n">quanZiVo</span><span class="p">.</span><span class="na">setCreateDate</span><span class="p">(</span><span class="n">RelativeDateFormat</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="k">new</span> <span class="n">Date</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getCreated</span><span class="p">())));</span>

            <span class="n">quanZiVoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">quanZiVo</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="c1">//查询用户信息</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s">&quot;userId&quot;</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserIdList</span><span class="p">(</span><span class="n">userIds</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">QuanZiVo</span> <span class="n">quanZiVo</span> <span class="p">:</span> <span class="n">quanZiVoList</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//找到对应的用户信息</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">quanZiVo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">().</span><span class="na">longValue</span><span class="p">()</span> <span class="o">==</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">().</span><span class="na">longValue</span><span class="p">())</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="na">fillUserInfoToQuanZiVo</span><span class="p">(</span><span class="n">userInfo</span><span class="p">,</span> <span class="n">quanZiVo</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">quanZiVoList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 发布动态</span>
<span class="cm">     *</span>
<span class="cm">     * @param textContent</span>
<span class="cm">     * @param location</span>
<span class="cm">     * @param latitude</span>
<span class="cm">     * @param longitude</span>
<span class="cm">     * @param multipartFile</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">savePublish</span><span class="p">(</span><span class="n">String</span> <span class="n">textContent</span><span class="p">,</span>
                              <span class="n">String</span> <span class="n">location</span><span class="p">,</span>
                              <span class="n">String</span> <span class="n">latitude</span><span class="p">,</span>
                              <span class="n">String</span> <span class="n">longitude</span><span class="p">,</span>
                              <span class="n">MultipartFile</span><span class="o">[]</span> <span class="n">multipartFile</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//查询当前的登录信息</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">Publish</span> <span class="n">publish</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Publish</span><span class="p">();</span>
        <span class="n">publish</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="n">publish</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">textContent</span><span class="p">);</span>
        <span class="n">publish</span><span class="p">.</span><span class="na">setLocationName</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
        <span class="n">publish</span><span class="p">.</span><span class="na">setLatitude</span><span class="p">(</span><span class="n">latitude</span><span class="p">);</span>
        <span class="n">publish</span><span class="p">.</span><span class="na">setLongitude</span><span class="p">(</span><span class="n">longitude</span><span class="p">);</span>
        <span class="n">publish</span><span class="p">.</span><span class="na">setSeeType</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">picUrls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="c1">//图片上传</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">MultipartFile</span> <span class="n">file</span> <span class="p">:</span> <span class="n">multipartFile</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PicUploadResult</span> <span class="n">picUploadResult</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">picUploadService</span><span class="p">.</span><span class="na">upload</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
            <span class="n">picUrls</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">picUploadResult</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="n">publish</span><span class="p">.</span><span class="na">setMedias</span><span class="p">(</span><span class="n">picUrls</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">publishId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">savePublish</span><span class="p">(</span><span class="n">publish</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">publishId</span><span class="p">)){</span>
            <span class="c1">//发送消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">quanziMQService</span><span class="p">.</span><span class="na">publishMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">publishId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryRecommendPublishList</span><span class="p">(</span><span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//分析：通过dubbo中的服务查询系统推荐动态</span>
        <span class="c1">//通过mysql查询用户的信息，回写到结果对象中（QuanZiVo）</span>

        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="c1">//直接从ThreadLocal中获取对象</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="c1">//通过dubbo查询数据</span>
        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Publish</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryRecommendPublishList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Publish</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">records</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">fillQuanZiVo</span><span class="p">(</span><span class="n">records</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 动态点赞</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">likeComment</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">likeComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">publishId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//发消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">quanziMQService</span><span class="p">.</span><span class="na">likePublishMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>

            <span class="c1">//查询点赞数</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 动态的取消点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">disLikeComment</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">disLikeComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">publishId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//发消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">quanziMQService</span><span class="p">.</span><span class="na">disLikePublishMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
            <span class="c1">//查询点赞数</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">loveComment</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="c1">//喜欢</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">loveComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">publishId</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">){</span>
            <span class="c1">//发消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">quanziMQService</span><span class="p">.</span><span class="na">lovePublishMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
            <span class="c1">//查询喜欢数</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLoveCount</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">disLoveComment</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="c1">//取消喜欢</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">disLoveComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">publishId</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">){</span>
            <span class="c1">//发消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">quanziMQService</span><span class="p">.</span><span class="na">disLovePublishMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
            <span class="c1">//查询喜欢数</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLoveCount</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">QuanZiVo</span> <span class="nf">queryById</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Publish</span> <span class="n">publish</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryPublishById</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">publish</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//发消息</span>
        <span class="k">this</span><span class="p">.</span><span class="na">quanziMQService</span><span class="p">.</span><span class="na">queryPublishMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">fillQuanZiVo</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">publish</span><span class="p">)).</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 查询评论列表</span>
<span class="cm">     *</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @param page</span>
<span class="cm">     * @param pageSize</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryCommentList</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="c1">//查询评论列表数据</span>
        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryCommentList</span><span class="p">(</span><span class="n">publishId</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">records</span><span class="p">)){</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//查询用户信息</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIdList</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s">&quot;userId&quot;</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserIdList</span><span class="p">(</span><span class="n">userIdList</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">CommentVo</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Comment</span> <span class="n">record</span> <span class="p">:</span> <span class="n">records</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">CommentVo</span> <span class="n">commentVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommentVo</span><span class="p">();</span>
            <span class="n">commentVo</span><span class="p">.</span><span class="na">setContent</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getContent</span><span class="p">());</span>
            <span class="n">commentVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toHexString</span><span class="p">());</span>
            <span class="n">commentVo</span><span class="p">.</span><span class="na">setCreateDate</span><span class="p">(</span><span class="n">DateUtil</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="k">new</span> <span class="n">Date</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getCreated</span><span class="p">()),</span> <span class="s">&quot;HH:mm&quot;</span><span class="p">));</span>
            <span class="c1">//是否点赞</span>
            <span class="n">commentVo</span><span class="p">.</span><span class="na">setHasLiked</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryUserIsLike</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">commentVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
            <span class="c1">//点赞数</span>
            <span class="n">commentVo</span><span class="p">.</span><span class="na">setLikeCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">commentVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span>


            <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">())){</span>

                    <span class="n">commentVo</span><span class="p">.</span><span class="na">setAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getLogo</span><span class="p">());</span>
                    <span class="n">commentVo</span><span class="p">.</span><span class="na">setNickname</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span>

                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">result</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">commentVo</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 发表评论</span>
<span class="cm">     * @param publishId</span>
<span class="cm">     * @param content</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">saveComments</span><span class="p">(</span><span class="n">String</span> <span class="n">publishId</span><span class="p">,</span> <span class="n">String</span> <span class="n">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">saveComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">publishId</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">){</span>
            <span class="c1">//发消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">quanziMQService</span><span class="p">.</span><span class="na">commentPublishMsg</span><span class="p">(</span><span class="n">publishId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryAlbumList</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="c1">//查询数据</span>
        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Publish</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryAlbumList</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">())){</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//填充数据</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">fillQuanZiVo</span><span class="p">(</span><span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">()));</span>

        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">VisitorsVo</span><span class="o">&gt;</span> <span class="nf">queryVisitorsList</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Visitors</span><span class="o">&gt;</span> <span class="n">visitorsList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">visitorsApi</span><span class="p">.</span><span class="na">queryMyVisitor</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">visitorsList</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">visitorsList</span><span class="p">,</span> <span class="s">&quot;visitorUserId&quot;</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserIdList</span><span class="p">(</span><span class="n">userIds</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">VisitorsVo</span><span class="o">&gt;</span> <span class="n">visitorsVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">Visitors</span> <span class="n">visitor</span> <span class="p">:</span> <span class="n">visitorsList</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="na">getVisitorUserId</span><span class="p">(),</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()))</span> <span class="p">{</span>

                    <span class="n">VisitorsVo</span> <span class="n">visitorsVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VisitorsVo</span><span class="p">();</span>
                    <span class="n">visitorsVo</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getAge</span><span class="p">());</span>
                    <span class="n">visitorsVo</span><span class="p">.</span><span class="na">setAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getLogo</span><span class="p">());</span>
                    <span class="n">visitorsVo</span><span class="p">.</span><span class="na">setGender</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getSex</span><span class="p">().</span><span class="na">name</span><span class="p">().</span><span class="na">toLowerCase</span><span class="p">());</span>
                    <span class="n">visitorsVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
                    <span class="n">visitorsVo</span><span class="p">.</span><span class="na">setNickname</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span>
                    <span class="n">visitorsVo</span><span class="p">.</span><span class="na">setTags</span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getTags</span><span class="p">(),</span> <span class="sc">&#39;,&#39;</span><span class="p">));</span>
                    <span class="n">visitorsVo</span><span class="p">.</span><span class="na">setFateValue</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="na">getScore</span><span class="p">().</span><span class="na">intValue</span><span class="p">());</span>

                    <span class="n">visitorsVoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">visitorsVo</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">visitorsVoList</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="35">3.5、接收消息<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<p>接收消息的工作需要新创建my-tanhua-recommend工程，在此工程中完成相关的操作。</p>
<h4 id="351my-tanhua-recommend">3.5.1、创建my-tanhua-recommend工程<a class="headerlink" href="#351my-tanhua-recommend" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>my-tanhua<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.itcast.tanhua<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>my-tanhua-recommend<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--引入interface依赖--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>cn.itcast.tanhua<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>my-tanhua-dubbo-interface<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-mongodb<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--RocketMQ相关--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.rocketmq<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>rocketmq-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.rocketmq<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>rocketmq-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>joda-time<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>joda-time<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>cn.hutool<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hutool-all<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div>

<h4 id="352">3.5.2、配置文件<a class="headerlink" href="#352" title="Permanent link">&para;</a></h4>
<p>application.properties</p>
<div class="codehilite"><pre><span></span><code><span class="na">spring.application.name</span> <span class="o">=</span> <span class="s">itcast-rocketmq</span>
<span class="na">server.port</span> <span class="o">=</span> <span class="s">18082</span>

<span class="c"># RocketMQ相关配置</span>
<span class="na">rocketmq.name-server</span><span class="o">=</span><span class="s">192.168.31.81:9876</span>
<span class="na">rocketmq.producer.group</span><span class="o">=</span><span class="s">tanhua</span>

<span class="c"># mongodb相关配置</span>
<span class="na">spring.data.mongodb.username</span><span class="o">=</span><span class="s">tanhua</span>
<span class="na">spring.data.mongodb.password</span><span class="o">=</span><span class="s">l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV</span>
<span class="na">spring.data.mongodb.authentication-database</span><span class="o">=</span><span class="s">admin</span>
<span class="na">spring.data.mongodb.database</span><span class="o">=</span><span class="s">tanhua</span>
<span class="na">spring.data.mongodb.port</span><span class="o">=</span><span class="s">27017</span>
<span class="na">spring.data.mongodb.host</span><span class="o">=</span><span class="s">192.168.31.81</span>
</code></pre></div>

<h4 id="353">3.5.3、启动类<a class="headerlink" href="#353" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.recommend</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RecommendApplication</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">RecommendApplication</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="354recommendquanzi">3.5.4、RecommendQuanZi<a class="headerlink" href="#354recommendquanzi" title="Permanent link">&para;</a></h4>
<p>存储到MongoDB的中的实体结构。</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.recommend.pojo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.bson.types.ObjectId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Document</span><span class="p">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">&quot;recommend_quanzi&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RecommendQuanZi</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">ObjectId</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="p">;</span><span class="c1">// 用户id</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">publishId</span><span class="p">;</span> <span class="c1">//动态id，需要转化为Long类型</span>
    <span class="kd">private</span> <span class="n">Double</span> <span class="n">score</span><span class="p">;</span> <span class="c1">//得分</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">date</span><span class="p">;</span> <span class="c1">//时间戳</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="355quanzimsgconsumer">3.5.5、QuanZiMsgConsumer<a class="headerlink" href="#355quanzimsgconsumer" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.recommend.msg</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONObject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Publish</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.recommend.pojo.RecommendQuanZi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.spring.annotation.RocketMQMessageListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.spring.core.RocketMQListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.bson.types.ObjectId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="nd">@RocketMQMessageListener</span><span class="p">(</span><span class="n">topic</span> <span class="o">=</span> <span class="s">&quot;tanhua-quanzi&quot;</span><span class="p">,</span>
        <span class="n">consumerGroup</span> <span class="o">=</span> <span class="s">&quot;tanhua-quanzi-consumer&quot;</span><span class="p">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuanZiMsgConsumer</span> <span class="kd">implements</span> <span class="n">RocketMQListener</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="n">JSONUtil</span><span class="p">.</span><span class="na">parseObj</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

            <span class="n">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getLong</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">);</span>
            <span class="n">Long</span> <span class="n">date</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getLong</span><span class="p">(</span><span class="s">&quot;date&quot;</span><span class="p">);</span>
            <span class="n">String</span> <span class="n">publishId</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getStr</span><span class="p">(</span><span class="s">&quot;publishId&quot;</span><span class="p">);</span>
            <span class="n">Long</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getLong</span><span class="p">(</span><span class="s">&quot;pid&quot;</span><span class="p">);</span>
            <span class="n">Integer</span> <span class="n">type</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">);</span>

            <span class="n">RecommendQuanZi</span> <span class="n">recommendQuanZi</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecommendQuanZi</span><span class="p">();</span>
            <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
            <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setDate</span><span class="p">(</span><span class="n">date</span><span class="p">);</span>
            <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setPublishId</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>

            <span class="c1">//1-发动态，2-浏览动态， 3-点赞， 4-喜欢， 5-评论，6-取消点赞，7-取消喜欢</span>

            <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>

                    <span class="n">Publish</span> <span class="n">publish</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">publishId</span><span class="p">),</span> <span class="n">Publish</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">publish</span><span class="p">))</span> <span class="p">{</span>
                        <span class="kt">double</span> <span class="n">score</span> <span class="o">=</span> <span class="mf">0d</span><span class="p">;</span>

                        <span class="c1">//获取图片数</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">size</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getMedias</span><span class="p">());</span>

                        <span class="c1">//获取文本的长度</span>
                        <span class="c1">//文字长度：50以内1分，50~100之间2分，100以上3分</span>
                        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="p">.</span><span class="na">length</span><span class="p">(</span><span class="n">publish</span><span class="p">.</span><span class="na">getText</span><span class="p">());</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="n">score</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mf">1d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mf">5d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">4</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mf">8d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">5</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mi">10</span><span class="n">d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">6</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="o">-</span><span class="mf">5d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">7</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="o">-</span><span class="mf">8d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">default</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendQuanZi</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mf">0d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

            <span class="p">}</span>

            <span class="c1">//数据保存到MongoDB中</span>
            <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">recommendQuanZi</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;处理消息出错！msg = &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="17">1.7、测试<a class="headerlink" href="#17" title="Permanent link">&para;</a></h3>
<p>测试方法：使用APP进行操作，可以看到在MongoDB中已经有数据写入。</p>
<p><img alt="image-20210126160159662" src="assets/image-20210126160159662.png" /></p>
<h2 id="4">4、部署推荐系统<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>在推荐系统中，我们将基于前面写入到推荐表中的数据通过Spark进行计算，在Spark计算完成后将结果写入到Redis中，以供在业务系统中进行查询。</p>
<p>推荐服务我们将基于docker的形式进行部署：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#拉取镜像</span>
docker pull registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-quanzi:1.0

<span class="c1">#创建容器</span>
docker create --name tanhua-spark-quanzi <span class="se">\</span>
--env <span class="nv">MONGODB_HOST</span><span class="o">=</span><span class="m">192</span>.168.31.81 <span class="se">\</span>
--env <span class="nv">MONGODB_PORT</span><span class="o">=</span><span class="m">27017</span> <span class="se">\</span>
--env <span class="nv">MONGODB_USERNAME</span><span class="o">=</span>tanhua <span class="se">\</span>
--env <span class="nv">MONGODB_PASSWORD</span><span class="o">=</span>l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV <span class="se">\</span>
--env <span class="nv">MONGODB_DATABASE</span><span class="o">=</span>tanhua <span class="se">\</span>
--env <span class="nv">MONGODB_COLLECTION</span><span class="o">=</span>recommend_quanzi <span class="se">\</span>
--env <span class="nv">SCHEDULE_PERIOD</span><span class="o">=</span><span class="m">10</span> <span class="se">\</span>
--env <span class="nv">REDIS_NODES</span><span class="o">=</span><span class="s2">&quot;192.168.31.81:6379,192.168.31.81:6380,192.168.31.81:6381&quot;</span> <span class="se">\</span>
registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-quanzi:1.0

<span class="c1">#参数说明</span>
<span class="c1">#MONGODB_HOST mongodb服务的地址</span>
<span class="c1">#MONGODB_PORT mongodb服务的端口</span>
<span class="c1">#MONGODB_USERNAME mongodb服务的认证用户名</span>
<span class="c1">#MONGODB_PASSWORD mongodb服务的认证密码</span>
<span class="c1">#MONGODB_DATABASE mongodb连接的数据库</span>
<span class="c1">#MONGODB_COLLECTION 操作表</span>
<span class="c1">#SCHEDULE_PERIOD  下次执行时间间隔，但是为分，默认为10分钟</span>
<span class="c1">#REDIS_NODES  redis集群地址，也可以使用单节点</span>

<span class="c1">#mongodb开启认证服务</span>
<span class="c1">#docker create --name mongodb --restart=always -p 27017:27017 -v mongodb:/data/db mongo:4.0.3 --auth</span>

<span class="c1">#启动服务，启动之后就会进行执行，在SCHEDULE_PERIOD时间后再次执行</span>
docker start tanhua-spark-quanzi

<span class="c1">#查看日志</span>
docker logs -f tanhua-spark-quanzi

<span class="c1">#执行完成后会将数据写入到redis中</span>
</code></pre></div>

<p>进入redis查看是否已经有数据： <img alt="image-20200821104559656" src="assets/image-20200821104559656.png" /></p>
<h2 id="5">5、小视频推荐<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>小视频的推荐和动态推荐的实现逻辑非常的类似。</p>
<h3 id="51">5.1、动态计分规则<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<ul>
<li>发布+2</li>
<li>点赞 +5</li>
<li>评论 + 10</li>
</ul>
<h3 id="52">5.2、发送消息<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<h4 id="521videomqservice">5.2.1、VideoMQService<a class="headerlink" href="#521videomqservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.VideoApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Video</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.spring.core.RocketMQTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VideoMQService</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">RocketMQTemplate</span> <span class="n">rocketMQTemplate</span><span class="p">;</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">VideoApi</span> <span class="n">videoApi</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 发布小视频消息</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">videoMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 点赞小视频</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">likeVideoMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消点赞小视频</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">disLikeVideoMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 评论小视频</span>
<span class="cm">     *</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">commentVideoMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">sendMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 发送小视频操作相关的消息</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId</span>
<span class="cm">     * @param type     1-发动态，2-点赞， 3-取消点赞，4-评论</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Boolean</span> <span class="nf">sendMsg</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

            <span class="n">Video</span> <span class="n">video</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">queryVideoById</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>

            <span class="c1">//构建消息</span>
            <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;videoId&quot;</span><span class="p">,</span> <span class="n">videoId</span><span class="p">);</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;vid&quot;</span><span class="p">,</span> <span class="n">video</span><span class="p">.</span><span class="na">getVid</span><span class="p">());</span>
            <span class="n">msg</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="na">rocketMQTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;tanhua-video&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;发送消息失败! videoId = &quot;</span> <span class="o">+</span> <span class="n">videoId</span> <span class="o">+</span> <span class="s">&quot;, type = &quot;</span> <span class="o">+</span> <span class="n">type</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="432videoservice">4.3.2、VideoService<a class="headerlink" href="#432videoservice" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.server.service</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.ObjectUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.dubbo.config.annotation.Reference</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.tobato.fastdfs.domain.conn.FdfsWebServer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.tobato.fastdfs.domain.fdfs.StorePath</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.github.tobato.fastdfs.service.FastFileStorageClient</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.User</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.pojo.UserInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.service.PicUploadService</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.utils.UserThreadLocal</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.common.vo.PicUploadResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.QuanZiApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.api.VideoApi</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.pojo.Video</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.dubbo.server.vo.PageInfo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.PageResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.server.vo.VideoVo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.multipart.MultipartFile</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>

<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VideoService</span> <span class="p">{</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">VideoApi</span> <span class="n">videoApi</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">PicUploadService</span> <span class="n">picUploadService</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">protected</span> <span class="n">FastFileStorageClient</span> <span class="n">storageClient</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">FdfsWebServer</span> <span class="n">fdfsWebServer</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">UserInfoService</span> <span class="n">userInfoService</span><span class="p">;</span>

    <span class="nd">@Reference</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">QuanZiApi</span> <span class="n">quanZiApi</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">QuanZiService</span> <span class="n">quanZiService</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">VideoMQService</span> <span class="n">videoMQService</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * 小视频上传</span>
<span class="cm">     *</span>
<span class="cm">     * @param picFile   封面图片</span>
<span class="cm">     * @param videoFile 视频文件</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">saveVideo</span><span class="p">(</span><span class="n">MultipartFile</span> <span class="n">picFile</span><span class="p">,</span> <span class="n">MultipartFile</span> <span class="n">videoFile</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">Video</span> <span class="n">video</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Video</span><span class="p">();</span>
        <span class="n">video</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
        <span class="n">video</span><span class="p">.</span><span class="na">setSeeType</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">//上传图片到阿里云oss</span>
            <span class="n">PicUploadResult</span> <span class="n">uploadResult</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">picUploadService</span><span class="p">.</span><span class="na">upload</span><span class="p">(</span><span class="n">picFile</span><span class="p">);</span>
            <span class="n">video</span><span class="p">.</span><span class="na">setPicUrl</span><span class="p">(</span><span class="n">uploadResult</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>

            <span class="c1">//上传视频到FastDFS中</span>
            <span class="n">StorePath</span> <span class="n">storePath</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">storageClient</span><span class="p">.</span><span class="na">uploadFile</span><span class="p">(</span><span class="n">videoFile</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">(),</span>
                    <span class="n">videoFile</span><span class="p">.</span><span class="na">getSize</span><span class="p">(),</span>
                    <span class="n">StrUtil</span><span class="p">.</span><span class="na">subAfter</span><span class="p">(</span><span class="n">videoFile</span><span class="p">.</span><span class="na">getOriginalFilename</span><span class="p">(),</span> <span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
                    <span class="kc">null</span><span class="p">);</span>
            <span class="n">video</span><span class="p">.</span><span class="na">setVideoUrl</span><span class="p">(</span><span class="n">fdfsWebServer</span><span class="p">.</span><span class="na">getWebServerUrl</span><span class="p">()</span> <span class="o">+</span> <span class="n">storePath</span><span class="p">.</span><span class="na">getFullPath</span><span class="p">());</span>


            <span class="n">String</span> <span class="n">videoId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">saveVideo</span><span class="p">(</span><span class="n">video</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">videoId</span><span class="p">)){</span>
                <span class="c1">//发送消息</span>
                <span class="k">this</span><span class="p">.</span><span class="na">videoMQService</span><span class="p">.</span><span class="na">videoMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotEmpty</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;上传小视频出错~ userId = &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;, file = &quot;</span> <span class="o">+</span> <span class="n">videoFile</span><span class="p">.</span><span class="na">getOriginalFilename</span><span class="p">(),</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryVideoList</span><span class="p">(</span><span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

        <span class="n">PageResult</span> <span class="n">pageResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PageResult</span><span class="p">();</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPage</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
        <span class="n">pageResult</span><span class="p">.</span><span class="na">setPagesize</span><span class="p">(</span><span class="n">pageSize</span><span class="p">);</span>

        <span class="n">PageInfo</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">pageInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">queryVideoList</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> <span class="n">pageInfo</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">records</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//查询用户信息</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">userIds</span> <span class="o">=</span> <span class="n">CollUtil</span><span class="p">.</span><span class="na">getFieldValues</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="s">&quot;userId&quot;</span><span class="p">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">UserInfo</span><span class="o">&gt;</span> <span class="n">userInfoList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">userInfoService</span><span class="p">.</span><span class="na">queryUserInfoByUserIdList</span><span class="p">(</span><span class="n">userIds</span><span class="p">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">VideoVo</span><span class="o">&gt;</span> <span class="n">videoVoList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Video</span> <span class="n">record</span> <span class="p">:</span> <span class="n">records</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">VideoVo</span> <span class="n">videoVo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VideoVo</span><span class="p">();</span>

            <span class="n">videoVo</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setCover</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getPicUrl</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setVideoUrl</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getVideoUrl</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">toHexString</span><span class="p">());</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setSignature</span><span class="p">(</span><span class="s">&quot;我就是我~&quot;</span><span class="p">);</span> <span class="c1">//TODO 签名</span>

            <span class="n">videoVo</span><span class="p">.</span><span class="na">setCommentCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryCommentCount</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span> <span class="c1">//评论数</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasFocus</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">isFollowUser</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoVo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否关注</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setHasLiked</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryUserIsLike</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span> <span class="o">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//是否点赞（1是，0否）</span>
            <span class="n">videoVo</span><span class="p">.</span><span class="na">setLikeCount</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="na">toInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getId</span><span class="p">())));</span><span class="c1">//点赞数</span>

            <span class="c1">//填充用户信息</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">UserInfo</span> <span class="n">userInfo</span> <span class="p">:</span> <span class="n">userInfoList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ObjectUtil</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">videoVo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span> <span class="n">userInfo</span><span class="p">.</span><span class="na">getUserId</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="n">videoVo</span><span class="p">.</span><span class="na">setNickname</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getNickName</span><span class="p">());</span>
                    <span class="n">videoVo</span><span class="p">.</span><span class="na">setAvatar</span><span class="p">(</span><span class="n">userInfo</span><span class="p">.</span><span class="na">getLogo</span><span class="p">());</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">videoVoList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">videoVo</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">pageResult</span><span class="p">.</span><span class="na">setItems</span><span class="p">(</span><span class="n">videoVoList</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">pageResult</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">likeComment</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">likeComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//发送消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">videoMQService</span><span class="p">.</span><span class="na">likeVideoMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消点赞</span>
<span class="cm">     *</span>
<span class="cm">     * @param videoId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">disLikeComment</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">disLikeComment</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">videoId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//发送消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">videoMQService</span><span class="p">.</span><span class="na">disLikeVideoMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiApi</span><span class="p">.</span><span class="na">queryLikeCount</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">saveComment</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">,</span> <span class="n">String</span> <span class="n">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiService</span><span class="p">.</span><span class="na">saveComments</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="n">content</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">){</span>
            <span class="c1">//发送消息</span>
            <span class="k">this</span><span class="p">.</span><span class="na">videoMQService</span><span class="p">.</span><span class="na">commentVideoMsg</span><span class="p">(</span><span class="n">videoId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="n">PageResult</span> <span class="nf">queryCommentList</span><span class="p">(</span><span class="n">String</span> <span class="n">videoId</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">page</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">pageSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">quanZiService</span><span class="p">.</span><span class="na">queryCommentList</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 关注用户</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">followUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">followUser</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">userId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 取消关注</span>
<span class="cm">     *</span>
<span class="cm">     * @param userId</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">disFollowUser</span><span class="p">(</span><span class="n">Long</span> <span class="n">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">UserThreadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">videoApi</span><span class="p">.</span><span class="na">disFollowUser</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span> <span class="n">userId</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="53">5.3、接收消息<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<h4 id="531recommendvideo">5.3.1、RecommendVideo<a class="headerlink" href="#531recommendvideo" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.recommend.pojo</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.bson.types.ObjectId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="p">;</span>

<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Document</span><span class="p">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">&quot;recommend_video&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RecommendVideo</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="n">ObjectId</span> <span class="n">id</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="p">;</span><span class="c1">// 用户id</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">videoId</span><span class="p">;</span> <span class="c1">//视频id，需要转化为Long类型</span>
    <span class="kd">private</span> <span class="n">Double</span> <span class="n">score</span><span class="p">;</span> <span class="c1">//得分</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">date</span><span class="p">;</span> <span class="c1">//时间戳</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="532videomsgconsumer">5.3.2、VideoMsgConsumer<a class="headerlink" href="#532videomsgconsumer" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.tanhua.recommend.msg</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONObject</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONUtil</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.tanhua.recommend.pojo.RecommendVideo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.spring.annotation.RocketMQMessageListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.spring.core.RocketMQListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.bson.types.ObjectId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="nd">@RocketMQMessageListener</span><span class="p">(</span><span class="n">topic</span> <span class="o">=</span> <span class="s">&quot;tanhua-video&quot;</span><span class="p">,</span>
        <span class="n">consumerGroup</span> <span class="o">=</span> <span class="s">&quot;tanhua-video-consumer&quot;</span><span class="p">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VideoMsgConsumer</span> <span class="kd">implements</span> <span class="n">RocketMQListener</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="n">JSONUtil</span><span class="p">.</span><span class="na">parseObj</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
            <span class="n">Long</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getLong</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">);</span>
            <span class="n">Long</span> <span class="n">vid</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getLong</span><span class="p">(</span><span class="s">&quot;vid&quot;</span><span class="p">);</span>
            <span class="n">Integer</span> <span class="n">type</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">);</span>

            <span class="c1">//1-发动态，2-点赞， 3-取消点赞，4-评论</span>
            <span class="n">RecommendVideo</span> <span class="n">recommendVideo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecommendVideo</span><span class="p">();</span>
            <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
            <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">ObjectId</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
            <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setDate</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">());</span>
            <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setVideoId</span><span class="p">(</span><span class="n">vid</span><span class="p">);</span>

            <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mf">2d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mf">5d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="o">-</span><span class="mf">5d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">case</span> <span class="mi">4</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mi">10</span><span class="n">d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">default</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">recommendVideo</span><span class="p">.</span><span class="na">setScore</span><span class="p">(</span><span class="mf">0d</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="na">mongoTemplate</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">recommendVideo</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;处理小视频消息失败~&quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="533">5.3.3、测试<a class="headerlink" href="#533" title="Permanent link">&para;</a></h4>
<p><img alt="image-20210126172911927" src="assets/image-20210126172911927.png" /></p>
<p>可以看到，用户1对于视频有点赞、取消点赞、评论等操作。</p>
<h3 id="54">5.4、部署推荐服务<a class="headerlink" href="#54" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1">#拉取镜像</span>
docker pull registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-video:1.0

<span class="c1">#创建容器</span>
docker create --name tanhua-spark-video <span class="se">\</span>
--env <span class="nv">MONGODB_HOST</span><span class="o">=</span><span class="m">192</span>.168.31.81 <span class="se">\</span>
--env <span class="nv">MONGODB_PORT</span><span class="o">=</span><span class="m">27017</span> <span class="se">\</span>
--env <span class="nv">MONGODB_USERNAME</span><span class="o">=</span>tanhua <span class="se">\</span>
--env <span class="nv">MONGODB_PASSWORD</span><span class="o">=</span>l3SCjl0HvmSkTtiSbN0Swv40spYnHhDV <span class="se">\</span>
--env <span class="nv">MONGODB_DATABASE</span><span class="o">=</span>tanhua <span class="se">\</span>
--env <span class="nv">MONGODB_COLLECTION</span><span class="o">=</span>recommend_video <span class="se">\</span>
--env <span class="nv">SCHEDULE_PERIOD</span><span class="o">=</span><span class="m">10</span> <span class="se">\</span>
--env <span class="nv">REDIS_NODES</span><span class="o">=</span><span class="s2">&quot;192.168.31.81:6379,192.168.31.81:6380,192.168.31.81:6381&quot;</span> <span class="se">\</span>
registry.cn-hangzhou.aliyuncs.com/itcast/tanhua-spark-video:1.0

<span class="c1">#启动服务</span>
docker start tanhua-spark-video

<span class="c1">#查看日志</span>
docker logs -f tanhua-spark-video
</code></pre></div>

<p>测试：</p>
<p><img alt="1570452212069" src="assets/1570452212069.png" /></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../day09/" class="md-footer__link md-footer__link--prev" aria-label="上一页: day09" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              day09
            </div>
          </div>
        </a>
      
      
        
        <a href="../further/lombok/" class="md-footer__link md-footer__link--next" aria-label="下一页: day01_lombok" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              day01_lombok
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019 peaceiris
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/peaceiris" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/piris314en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>